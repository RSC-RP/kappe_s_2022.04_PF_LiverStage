---
title: "CVG and Translocome Gene Expression"
author: "Jenny L Smith"
date: "`r Sys.Date()`"
output: html_document
---

# Set-up 

```{r set-up}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=50),
                      tidy=TRUE,
                      fig.align='center',
                      fig.width = 10, fig.height = 10)

options(stringsAsFactors = FALSE, max.print = 100)
table = function (..., useNA = 'ifany') base::table(..., useNA = useNA)
```

```{r message = FALSE, warning=FALSE}
library(tidyr)
library(tibble)
library(magrittr)
library(dplyr)
library(stringr)
library(ComplexHeatmap)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(patchwork)
library(limma)
library(edgeR)


library(SummarizedExperiment)
library(patchwork)
# library(maSigPro)
library(svglite)
suppressPackageStartupMessages(library(mclust))

library(Biostrings)
```


Note about fonts:

```{r}
#https://www.tidyverse.org/blog/2021/02/svglite-2-0-0/
# system_fonts = list(sans = "Open Sans")
# systemfonts::system_fonts()
```

# Define Functions 

```{r}
#from https://github.com/mikelove/DESeq2/blob/master/R/plots.R
#Want to return the whole scores matrix so can examine 3d pca plots. 
plotPCA.DESeq.mod <- function(object, intgroup="condition", ntop=500, returnData=FALSE, PC3=FALSE)
{
  library(matrixStats)
  # calculate the variance for each gene
  rv <- rowVars(assay(object))
  
  # select the ntop genes by variance
  select <- order(rv, decreasing=TRUE)[seq_len(min(ntop, length(rv)))]
  
  # perform a PCA on the data in assay(x) for the selected genes
  pca <- prcomp(t(assay(object)[select,]))
  
  # the contribution to the total variance for each component
  percentVar <- pca$sdev^2 / sum( pca$sdev^2 )
  
  if (!all(intgroup %in% names(colData(object)))) {
    stop("the argument 'intgroup' should specify columns of colData(dds)")
  }
  
  intgroup.df <- as.data.frame(colData(object)[, intgroup, drop=FALSE])
  
  # add the intgroup factors together to create a new grouping factor
  group <- if (length(intgroup) > 1) {
    factor(apply( intgroup.df, 1, paste, collapse=":"))
  } else {
    colData(object)[[intgroup]]
  }
  
  # assembly the data for the plot - first 10 PCs
  # d <- data.frame(PC1=pca$x[,1], PC2=pca$x[,2], group=group, intgroup.df, name=colnames(object))
  n <- min(10, ncol(as.data.frame(pca$x)))
  d <- data.frame(as.data.frame(pca$x)[,1:n], group=group, intgroup.df, name=colnames(object))
  
  if (returnData) {
    attr(d, "percentVar") <- percentVar[1:10]
    rot <- pca$rotation[,1:10] #for first 10 PCs
    dat <- list("scores"=d,"rotation"=rot)
    return(dat)
  }
}

#Updated on 6/9/17 to use variance stabilized transformed data as input (not center scaled log2, like in princomp)
PCA <- function(expnData,phenovector,
                title="",round=TRUE,colorCodes=NULL,
                ntop=500, GOI=NULL){
  
  suppressPackageStartupMessages(library(DESeq2))
  library(ggplot2)
  #expnData is the raw counts (not normalized) has patient IDs as colnames and genes as rownames. 
  
  samples <- intersect(names(phenovector), colnames(expnData))
  countData <- expnData[,samples]
  phenovector <- phenovector[samples]
  colData <- as.data.frame(phenovector)
  
  if(round){
    countData <- round(countData, digits = 0)
  }
  
  #Create as DESeq data set object (dds)
  dds <- DESeqDataSetFromMatrix(countData = countData,
                                  colData = colData,
                                  design = ~ 1)
  
  #perform variance stabilized transformation 
  dds <- dds[ rowSums(counts(dds)) > 10, ]
  varianceStab <- vst(dds, blind = TRUE)
  
  #if given a list of genes of interest
  if (! is.null(GOI)){
    GOI <- intersect(GOI, rownames(assay(varianceStab)))
  }else{
    GOI <- 1:nrow(varianceStab)
  }
  
  #PCA data frame with the wieghts/loadings and eigen vectors
  pca.dat <- plotPCA.DESeq.mod(varianceStab[GOI,], 
                               intgroup = "phenovector", 
                               ntop = ntop,
                               returnData=TRUE)
  
  plots <- lapply(c(2:3), function(pc){
      percentVar <- attr(pca.dat$scores, which="percentVar")
      y_var <- paste0("PC",pc)
      
      p <- ggplot(data=pca.dat$scores, 
             aes_string(x="PC1", y=y_var, color="phenovector")) + 
        geom_point(size=3, alpha=0.75) +
        xlab(paste0("PC1: ",round(percentVar[1] * 100),"% variance")) +
        ylab(paste0(y_var,": ",round(percentVar[pc] * 100),"% variance")) +
        labs(title=title) +
        theme_classic() +
        theme(legend.position = "top")
      if(!is.null(colorCodes)){
        p <- p + 
          scale_color_manual(values=colorCodes)
      }
      return(p)
  })
  
  #Final Results object
  res <- list(dds, varianceStab,pca.dat, plots)
  names(res) <- c("dds", "vst","pca_data","pca_plots")
  
  if(is.character(GOI)){
    res[["GOI"]] <- GOI
  }
  
  return(res)
}
```

```{r}
#changed on 2/14/18, see bottom of Heatmaps_Function.r for the original one used.
dge_dendrograms <- function(expnData, pheno, method,
                            genelist=NULL,add.count=1, percent=0.05,
                            ntop=500,filterTopGenes=FALSE, createDGE=TRUE,log=FALSE){
  #df with count data, patient IDs are column names and rows are genes.
  #pheno is a character vector with patient IDs as names, and the status for each in each group (eg pos,neg)
  #genelist is a character vector with the genes of interest
  #percent is the % of samples in the input expn matrix that must express a gene at 1 CPM. Filter to remove low count genes.
  #set log=TRUE if providing a log2 expression dataframe.
  #filterTopGenes shuold be a logical. If TRUE filter top 1000 most varied genes.
  suppressPackageStartupMessages(require(edgeR))
  suppressPackageStartupMessages(library(dendextend))
  suppressPackageStartupMessages(library(matrixStats))

  expnData <- expnData[, intersect(names(pheno), colnames(expnData))] #ensure correct order, drop rows with nas just in case
  if(createDGE){
    dge <- DGEList(counts = expnData)
    #keep the rows (genes) with at least 1 CPM in a minimum of 2 samples or X% of samples. 
    keep.dge <- rowSums(cpm(dge) >= 1) >= max(2,(percent*ncol(expnData))) 
    # subset for those genes with cmp >= 1 per gene in samples
    dge <- dge[keep.dge,] #
    dge <- calcNormFactors(dge)
    TMMCPM <- cpm(dge, normalized.lib.sizes = TRUE,
                  log = TRUE, prior.count = add.count)

  }else{
    TMMCPM <- as.matrix(expnData)
    if(!log){
      TMMCPM <- log2(expnData+add.count) #log2 transform counts
    }
  }

  if(is.null(genelist) & filterTopGenes){
      # calculate the variance for each gene
      rv <- rowVars(as.matrix(TMMCPM))
      # select the ntop genes by variance
      select <- order(rv, decreasing=TRUE)[seq_len(min(ntop, length(rv)))]
      #select the top 1000 most varied genes
      TMMCPM <- TMMCPM[select,]
  }else if(!is.null(genelist)){
    TMMCPM <- TMMCPM[which(rownames(TMMCPM) %in% genelist), ] #subset the matrix to genes of interest
  }


  d1 <- dist(t(TMMCPM), method = "euclidean", diag = FALSE,
             upper = FALSE) #sample distances WITHOUT SCALING
  d2 <- dist(TMMCPM, method = "euclidean", diag = FALSE,
             upper = TRUE) #gene distances WITHOUT SCaling
  samp.c1 <- hclust(d1, method = method, members = NULL) #sample clustering
  gene.c2 <- hclust(d2, method = method, members = NULL) #gene clustering
  list <- list(TMMCPM,samp.c1,gene.c2)
  names(list) <- c("TMMCPM","samp.c1", "gene.c2")

  return(list)
}

```


```{r}
#Pheatmap
quickPheatmap <- function(expn,geneList, sample_data,
                          gene_index=NULL,
                          annots_col_colors=NULL){
  library(pheatmap)

  len <- 299
  col <- colorRampPalette(c("deepskyblue4", "deepskyblue3", "deepskyblue2", "deepskyblue1","white","red1", "red2", "red3", "red4"))(n=len)

  e <- expn[geneList, intersect(colnames(expn), rownames(sample_data))]
  sample_data <- sample_data[intersect(colnames(expn), rownames(sample_data)), ]
  anno.col <- sample_data
  #if scaling, this doesnt work. would need to scale the expression matrix myself
  # Breaks <- c(seq(min(e), 0, length.out=ceiling(len/2) + 1),
  #             seq(max(e)/len, max(e), length.out=floor(len/2)))
 
  if(is.null(annots_col_colors)){
    annots_col_colors <- lapply(anno.col, function(column){
        grps <- unique(column)
        n <- length(grps)
        pal <- RColorBrewer::brewer.pal(n,name="Set1")
        names(pal) <- grps
        return(pal)
      })
  }


  p <- pheatmap::pheatmap(mat= e ,
                     color=col,
                     border_color="black",
                     scale = "row", 
                     cluster_rows=FALSE,
                     cluster_cols=TRUE,
                     clustering_method="ward.D2",
                     clustering_distance_cols="correlation",
                     annotation_names_col=TRUE,
                     annotation_col = anno.col,
                     annotation_colors = annots_col_colors,
                     gaps_row=gene_index,
                     show_rownames=TRUE,
                     fontsize_row=5,
                     fontsize_col = 10,
                     # kmeans_k=9,
                     show_colnames=TRUE)


  return(p)

}
```

```{r}
create_annots_hmap <- function(expn, pheno_df, cols,
                               goi=NULL,cc=NULL, 
                               colorbar.height=5){
  #expn is the normalized expression values with genes as rownames
  #gene list a character vector
  #goi are genes of interest to highlight on the Heatmap. Character vector of gene symbols
  #cc are color codes in WHICH FORMAT?
  #cols is a character vector of column names

  #Example on how to use the reuslts:
  #hmap <- ComplexHmap(XXXX, hmap_anno_obj=res$annoColumn, XXX)
  # draw(hmap + res$geneLabels, heatmap_legend_side="right", annotation_legend_side="right")

    library(dplyr)
    suppressPackageStartupMessages(library(ComplexHeatmap))

    #subset the expression matix and the phenotype dataframe
    anno <- pheno_df %>%
      dplyr::filter(rownames(.) %in% colnames(expn)) %>% 
      rownames_to_column("id") %>% 
      dplyr::select(id, all_of(cols)) %>%
      mutate(id = factor(id, levels = colnames(expn))) %>%
      arrange(id) %>%  #ensure same order as the expn matrix
      column_to_rownames("id")
  
    #if no color codes provided, create one for each column
    if(is.null(cc)){
      pals <- c("npg", "aaas", "lancet", "jco", 
                    "ucscgb", "uchicago", "simpsons",
                    "rickandmorty")
      #if there are more columns than color palettes, just repeat the set of available color palettes
      if(length(ncol(anno)) > length(pals)){
        pals <- rep(pals,  ceiling(ncol(anno)/length(pals)))
      }
      #define unique colors for each column
      cc <- purrr::map(1:ncol(anno), function(i){
          grps <- unique(anno[[i]])
          ggpubr::get_palette(pals[i], k=length(grps)) %>% 
            magrittr::set_names(grps)
      })
      names(cc) <- colnames(anno)
    }
    
    #legend graphical parameters
    n <- max(sapply(cc, length))
    nrow <- ifelse(n <= 6, n, 6)
    ncol <- ceiling(n/nrow)
    params <- list(show_legend=TRUE,
                  labels_gp= gpar(fontsize=12),
                  title_gp= gpar(fontsize=16),
                  nrow = nrow,
                  ncol=ncol,
                  by_row=TRUE)
    
    #Create the complex heatmap annotation column
    annoCol <- suppressWarnings(HeatmapAnnotation(df = dplyr::select(anno, all_of(cols)),
                                   name="Main Groups",
                                   col=cc,
                                   which="column",
                                   gap=unit(1,"mm"),
                                   border = T,
                                   show_annotation_name = TRUE,
                                   annotation_name_gp=gpar(fontsize=12),
                                   annotation_name_offset=unit(1,"mm"),
                                   annotation_name_side="left",
                                   annotation_height=unit(colorbar.height, "cm"),
                                   annotation_legend_param = params,
                                   simple_anno_size_adjust=TRUE))
    res <- list("annoColumn"=annoCol)
    if(!is.null(goi)){
      regex <- paste0("^",goi,"$", collapse = "|")
      goi.idx <- grep(regex, rownames(expn))
      labels <- rownames(expn)[goi.idx] #needs to be numeric indexes for complexheatmap
      #create the row (gene) labels object
      labs <- circlize::rowAnnotation(link = anno_mark(at=goi.idx,
                                             labels=labels,
                                             which="row",
                                             link_width=unit(1, "mm")),
                            width= unit(1, "mm") + max_text_width(labels),
                            gp=gpar(fontsize=4))

      res[["geneLabels"]] <-  labs
    }
    return(res)
}


complex_hmap <- function(mat,
                        hmap_anno_obj,
                        hmap_anno_obj_genes=NULL,
                        name="z-scores",
                        scale=TRUE,
                        space.type="sRGB",
                        color_palette=NULL,
                        split=NULL, 
                        cluster.method="ward.D2",
                        show_sample_ids=FALSE,
                        dge_dendrograms.res=NULL,
                        samp_dend_order=NULL){
  #mat is the normalized, log2 (usually) transformed counts
  #name is the title
  #scale is whether to scale by row
  #color palette is a colorRamp2() object.
  #threshold is whether to make all z-scores in a certain range.
  #hmap_anno_obj is from HeatmapAnnotation() function
  #space.type is for the color/shades on the heatmap. See ?Heatmap for all the choices.
  #dge_dendrograms.res is the list object output from the dge_dendrograms() function.
  #samp_dend_order is the numeric vector or character vector of column names from the matrix (mat) or the dge_dengrograms.res$TMMCPM matix, in the desired order.

  suppressPackageStartupMessages(library(ComplexHeatmap))
  suppressPackageStartupMessages(require(circlize))
  library(RColorBrewer)
  suppressPackageStartupMessages(library(dendextend))
  ht_opt$message = FALSE

   if(scale){
      mat <- t(scale(t(mat))) ##rowwise scaling
   }
  
  print(range(mat))
  min <- round(min(mat))
  max <- round(max(mat))
  mid <- round(max/2, digits = 2)
    
  if(is.null(color_palette)){
    pal <- colorRamp2(c(min,-mid, 0, mid, max),
                      c("deepskyblue3", "deepskyblue","white", "red", "red3"),
                      space=space.type)
  }else{
    pal <- color_palette
  }
  # col <- colorRampPalette(c("cyan1", "cyan2", "cyan3", "cyan4","azure4","magenta4", "magenta3", "magenta2", "magenta1"))(n=299)
  #colorRamp2(c(-2, 0, 4), c("deepskyblue","white", "red"), space="RGB") #use for breaks.
  # colorPal <- colorRampPalette(c("deepskyblue4", "deepskyblue3", "deepskyblue2", "deepskyblue1","white","red1", "red2", "red3", "red4"))(n=299)

  #legend graphical parameters
  params <-  list(color_bar="continuous",
       legend_direction="horizontal",
       title_position="topcenter",
       legend_width=unit(5,"cm"),
       legend_height=unit(5,"cm"),
       title_gp=gpar(fontsize=10,
                     fontface="bold"),
      at = c(min,-mid, 0,mid, max),
      just = c("left", "top"))
  
    if(!is.null(dge_dendrograms.res)){
        if(is.null(samp_dend_order)){
          clust <- dendextend::rotate(as.dendrogram(dge_dendrograms.res$samp.c1),
                           order=c(ncol(mat):1))
        }else{
          clust <- dendextend::rotate(as.dendrogram(dge_dendrograms.res$samp.c1),
                                  order=samp_dend_order)
      }
    }else{
      clust=TRUE
    }

    #create the heatmap plot
    hmap <- Heatmap(mat,
                    name=name,
                    col=pal,

                    heatmap_legend_param=params,
                    row_title="Genes",
                    row_title_side="left",
                    row_title_gp=gpar(fontsize=15,
                                      fontface="bold"),
                    show_row_names=FALSE,
                    show_column_names=show_sample_ids,
                    row_names_gp=gpar(fontsize=3),

                    column_title="Samples",
                    column_title_side="bottom",
                    column_title_gp=gpar(fontsize=15,
                                         fontface="bold"),
                    column_title_rot=0,
                    row_dend_width=unit(8,"mm"),
                    column_dend_height=unit(22.5,"mm"),

                    top_annotation=hmap_anno_obj,
                    right_annotation = hmap_anno_obj_genes,
                    split=split,
                    row_gap = unit(5, "mm"),

                    clustering_distance_rows="euclidean",
                    clustering_method_rows=cluster.method,
                    clustering_method_columns = cluster.method,
                    cluster_columns = clust,
                    column_dend_reorder=FALSE)

  return(hmap)
}
```

```{r}
create_pf_heatmaps <- function(TMMCPM,sample_annots, gene_annots,
                               center_scale=TRUE,
                               ntop=1000,order_ids=NULL,
                               genelist=NULL,
                               split=NULL,
                               heatmap_colors=NULL){
  pf_genes <- gene_annots %>% 
    as.data.frame() %>% 
    dplyr::filter(genome=="PF3D7") %>% 
    pull(gene_id)
  
  TMMCPM_all_pf <- TMMCPM[rownames(TMMCPM) %in% pf_genes, ]
  dends <- dge_dendrograms(expnData = TMMCPM_all_pf, 
                           pheno = pull(sample_annots, analysis_factor_group, name = masigpro_id), 
                           method = "ward.D2",
                           genelist = genelist, 
                           ntop=ntop,
                           log=FALSE,
                           filterTopGenes = TRUE,
                           createDGE = FALSE)
  
  # dim(dends$TMMCPM)
  hmap_anno_obj <- create_annots_hmap(expn=dends$TMMCPM,
                                      pheno_df = sample_annots,
                                      cc=NULL,
                                      colorbar.height=2,
                                      cols = c("analysis_factor_group"))
  
  name <- ifelse(center_scale, "z-scores","log2_CPM")
  res <- complex_hmap(mat=dends$TMMCPM, 
               scale=center_scale,
               name=name,
               hmap_anno_obj = hmap_anno_obj$annoColumn,
               dge_dendrograms.res = dends,
               samp_dend_order=order_ids,
               color_palette=heatmap_colors,
               split=split,
               show_sample_ids=TRUE)
  
  return(list("dends"=dends,"heatmap"=res))
  
}
```

```{r}
aa_motif_search <- function(motif, aa_to_search){
  
  outname <- str_split_fixed(names(aa_to_search), pattern = " | ", n=2)[,1] %>% 
    gsub("-",".", .)
  matches <- str_extract_all(string = as.character(aa_to_search),
                             pattern = motif) %>% 
    set_names(outname) 
  coords <- str_locate_all(string = as.character(aa_to_search), 
               pattern = motif) %>% 
    set_names(outname) 
          

  idx <- sapply(matches,length) > 0
  matches[!idx] <- ""
  toFill <- max(sapply(matches,length))
  matches_clean <- lapply(matches, function(x){
    n <- length(x)
    dummy_n <- toFill - n
    x <- c(x[1:n], rep("",dummy_n))
  }) %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
               names_to = "aa_name",
               values_to = "match") %>% 
  arrange(aa_name) %>% 
  group_by(aa_name) %>% 
  filter(!duplicated(match)) %>% 
  mutate(keep=case_when(
    n() > 1 ~ !grepl("^$", match),
    TRUE ~ TRUE
  )) %>%
  filter(keep) %>% 
  summarise(n_matches=n(),
            match=paste(match[match != ""], collapse = "; ")) %>%
  ungroup()  %>% 
  mutate(n_matches=ifelse(grepl("^$", match), 0, n_matches))
  
  
  coords_clean <- purrr::map_dfr(names(coords), function(x){
    locs <- as.data.frame(coords[[x]])
    n <- nrow(locs)
    reps <- max(1,n)
    if(n < 1){
      df <- data.frame(aa_name=rep(x, reps)) %>% 
        mutate(start=NA_integer_, end=NA_integer_)
    }else{
      df <- data.frame(aa_name=rep(x, reps)) %>% 
       bind_cols(locs)
    }
  }) %>% 
    mutate(position=ifelse(!is.na(start), paste(start,end,sep="-"), "")) %>%
    group_by(aa_name) %>% 
    mutate(position = paste(position, collapse = "; ")) %>%
    ungroup() %>% 
    select(aa_name, position) %>% 
    distinct()
  
  results <- matches_clean %>% 
    left_join(coords_clean, by="aa_name")

  return(results)
}
```

# Sample Manifest and Expression Data

```{r}
pf_samples <- read.csv("samples/Kappe_s_2022.04_PF_LiverStage_ParasitesPaper_sample_manifest_7.25.2022.csv") %>% 
  set_rownames(.$sample_id_cat)

dim(pf_samples)
table(pf_samples$analysis_group)
```

```{r}
cb_se <- readRDS("expression_data/kappe_s_PfHsMmu_cated_Pf_ParasitesPaper_samples_Pf3D7v58_combat-seq_SummarizedExperiment.RDS")

cb_se
```

```{r}
cb_eset <- readRDS("expression_data/kappe_s_PfHsMmu_cated_Pf_ParasitesPaper_samples_Pf3D7v58_combat-seq_expressionSet.RDS")

# cb_eset
```

```{r}
counts <- read.csv("raw_counts/kappe_s_PfHsMmu_GRCh38_GRCm39_Pf3D7v58_raw_counts.csv")

dim(counts)
# head(counts)
```

```{r}
TPM <- read.csv("expression_data/kappe_s_PfHsMmu_PF3D7_TPM.csv")
rownames(TPM) <- TPM$gene_name

head(TPM)
```

# Genome References 

```{r}
PF3D7 <- AnnotationDbi::loadDb("species_genomes/plasmoDB/PlasmoDB-58_Pfalciparum3D7.sqlite")
# PF3D7
```

```{r}
PF3D7_gene_annots <- read.csv("species_genomes/PfHsMmu_GRCh38_GRCm39_Pf3D7v58_genes_annots.csv") %>% 
  filter(genome=="PF3D7")

dim(PF3D7_gene_annots)
head(PF3D7_gene_annots)
```


```{r}
genome <- Biostrings::readDNAStringSet("species_genomes/plasmoDB/PlasmoDB-58_Pfalciparum3D7_Genome.fasta")
names(genome) <- str_split_fixed(names(genome), pattern = " \\|", n=3)[,1]
```

```{r}
CDS <- cdsBy(PF3D7,by = "tx", use.names=TRUE)

minus_strand <- sapply(CDS, function(gr) (strand(gr) == "-")@values)
length(CDS)
```

```{r}
proteins_aa <- Biostrings::readAAStringSet("species_genomes/plasmoDB/PlasmoDB-58_Pfalciparum3D7_AnnotatedProteins.fasta")

head(proteins_aa)
length(proteins_aa) #5389

# names(proteins_aa) <- gsub("^(PF3D7.+p[0-9])\\s.+","\\1",names(proteins_aa))
# Biostrings::writeXStringSet(proteins_aa, "results/cvgs_pexel_domains/PF3D7_full_length_protein.fasta")
```
```{r}
cds_fasta <- Biostrings::readDNAStringSet("species_genomes/plasmoDB/PlasmoDB-58_Pfalciparum3D7_AnnotatedCDSs.fasta")

head(cds_fasta)
length(cds_fasta) #5389
```

```{r}
test_cds_gr <- CDS[minus_strand][["PF3D7_0100200.1"]]
cds_seq <- BSgenome::getSeq(genome, test_cds_gr)

# negative strand does not appear to affect the translation of the aa sequence
t1 <- xscat(translate(cds_seq[1]), translate(cds_seq[2])) %>% 
  narrow(.,end = 331) %>% 
  unname()

t2 <- proteins_aa[grep("PF3D7_0100200.1", names(proteins_aa))] %>% 
  unname()

t3 <- Biostrings::translate(cds_fasta[grep("PF3D7_0100200.1", names(cds_fasta))]) %>% 
    narrow(.,end = 331) %>% 
    unname()

identical(class(t1),class(t2)) # TRUE
identical(as.character(t1),as.character(t2)) # TRUE
identical(as.character(t1), as.character(t3))
```

```{r}
conflicted::conflict_prefer("filter","dplyr")
conflicted::conflict_prefer("select","dplyr")
conflicted::conflict_prefer("arrange","dplyr")
conflicted::conflict_prefer("mutate","dplyr")
```

```{r}
mito_genes <- PF3D7_gene_annots %>% 
  as.data.frame() %>% 
  filter(seqnames == "Pf3D7_MIT_v3" | grepl("mitochondrial", description, ignore.case = TRUE))

dim(mito_genes)
```


# VAR Genes Expression

```{r}
sheet_names <- paste0("PfCVG_",c("var","rifin","stevor","Pfmc-2TM","PfACS","CLAG"))
```

```{r}
conflicted::conflict_prefer("select","dplyr")
cvgs <- purrr::map_dfr(sheet_names, function(sheet){
  openxlsx::readWorkbook("references/CVGs.xlsx",sheet) %>% 
    mutate(type=sheet) %>% 
    select(type, everything())
}) %>% 
  janitor::clean_names()

head(cvgs)
dim(cvgs) #316
table(cvgs$type)
```

```{r}
sel_samps <- pf_samples %>% 
  filter(!grepl("Day2", time_point)) %>% 
  mutate(analysis_factor_group = gsub("Heps_", "", analysis_factor_group) %>% 
           paste0(.,"_LS") %>% 
           gsub("sporo.+","sporozoites", .),
         analysis_group_id = gsub("Heps_|\\+","", analysis_group_id) %>% 
           gsub("_S","_Rep", .) %>% 
           gsub("(Day[0-9]_)(Rep[0-9]).+", "\\1Pf_LS_\\2", .) %>% 
           gsub("sporo.+(_Rep[0-9])","sporozoites\\1", .)
         ) %>% 
  set_rownames(.$analysis_group_id)

# sel_samps
table(sel_samps$analysis_factor_group)
# table(sel_samps$analysis_group_id)
```

```{r}
cvg_expn <- log2(TPM[,sel_samps$sample_id_cat]+1)
colnames(cvg_expn) <- sel_samps$analysis_group_id

include <- base::intersect(cvgs$gene_id, rownames(cvg_expn))
cvg_expn <- cvg_expn[include,]
cvg_expn <- cvg_expn[rowSums(cvg_expn) > 0, ]

# head(cvg_expn[,1:5])
dim(cvg_expn) 
# any(duplicated(rownames(cvg_expn)))
```

```{r}
# cvgs %>% 
#   group_by(type) %>% 
#   dplyr::count() %>% 
#   write.csv(.,"results/cvgs_pexel_domains/cvgs_counts_table.csv", row.names = F)

cvgs %>%
  filter(gene_id %in% rownames(cvg_expn)) %>%
  group_by(type) %>%
  dplyr::count() 
#   write.csv(., "results/cvgs_pexel_domains/cvgs_counts_table_filtered_by_expression.csv", row.names = F)

missing <- dplyr::setdiff(cvgs$gene_id, rownames(cvg_expn))
# length(missing)
missing_raw_counts <- counts %>% 
  filter(gene_name %in% missing) %>% 
  pivot_longer(cols = -gene_name,
               names_to = "sample_id_cat",
               values_to = "counts") %>% 
  inner_join(., pf_samples, by="sample_id_cat") %>% 
  group_by(time_point) %>% 
  summarise(mean=mean(counts),
            median=median(counts), 
            sd=sd(counts))

# write.csv(missing_raw_counts,"results/cvgs_pexel_domains/missing_raw_counts_summary.csv", row.names = FALSE)
```

```{r}
cvg_expn_long <- cvg_expn %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  pivot_longer(cols = -gene_id,
               names_to = "analysis_group_id",
               values_to = "log2TPM") %>% 
  inner_join(., sel_samps, by="analysis_group_id") %>%
  left_join(., cvgs, by=c("gene_id")) %>%
  select(gene_id:log2TPM, type, product, everything())

cvg_expn_long
# table(cvg_expn_long$type)
```

```{r}
cvg_expn_summary_stats <- cvg_expn_long  %>% 
  group_by(product, gene_id, analysis_factor_group) %>% 
  summarise(min = min(log2TPM),
            median = median(log2TPM),
            mean = mean(log2TPM),
            max = max(log2TPM),
            sd = sd(log2TPM)) %>% 
  rename_at(vars(min:sd), ~paste0(.,"_log2TPM"))

# write.csv(cvg_expn_summary_stats,"results/cvgs_pexel_domains/CVG_gene_expression_summary_table.csv", row.names = FALSE)
```


```{r eval=FALSE}
# Day 6 boxplots
purrr::map(sheet_names, function(cvg_type){
  input <- cvg_expn_long %>% 
    filter(time_point == "Day6") %>% 
    filter(type==cvg_type) %>% 
    group_by(gene_id) %>% 
    mutate(mean_expn=mean(log2TPM)) %>% 
    ungroup() %>% 
    arrange(desc(mean_expn)) %>% 
    mutate(gene_id=factor(gene_id, levels = unique(gene_id))) %>% 
    select(gene_id:log2TPM, mean_expn, everything())
  
  n <- length(unique(input$gene_id))
  fig_width <- ifelse(n<=11, 4, 15)
  
  # svglite(paste0("figures/uncorrected/cvgs_pexel/cvg_", cvg_type,"_TPM_expression_boxplot.svg"), fix_text_size=FALSE, system_fonts = list(sans = "Open Sans"), height = 5, width = fig_width)
  print(ggplot(input, 
         aes(x=gene_id, y=log2TPM, fill=analysis_factor_group)) +
    geom_boxplot(color="grey50", alpha=0.2) +
    geom_point(aes(color=analysis_factor_group), 
               position = position_jitter(width = 0.3),
               size=2, alpha=0.75) +
    scale_fill_manual(values=ggpubr::get_palette("npg",4)[4]) +
    scale_color_manual(values=ggpubr::get_palette("npg",4)[4]) +
    facet_wrap(~type, scale="free_x") +
    labs(x="") +
    theme_classic() +
    theme(axis.text.x = element_text(angle=25, vjust=1,hjust=1),
          plot.margin = margin(l=6,unit="mm"),
          legend.position = "top"))
  # dev.off()
})
```

```{r fig.height=10, fig.width=10}
colanno_df <- sel_samps %>% 
  filter(time_point != "Day0") %>% 
  select(time_point = analysis_factor_group) 

mat <- as.matrix(cvg_expn[, rownames(colanno_df)]) 
mat <- mat[rowSums(mat) > 0, ]

colanno <-  HeatmapAnnotation(df = colanno_df,
                    which = "column",
                    col = list(time_point=ggpubr::get_palette("jco",3) %>%
                                          set_names(unique(colanno_df$time_point))))


rowanno <- cvgs %>% 
  filter(gene_id %in% rownames(mat)) %>% 
  select(-product, CVG_type=type) %>% 
  column_to_rownames("gene_id") 

gap_index <- rowanno %>% 
  group_by(CVG_type) %>%
  mutate(n=n()) %>% 
  ungroup() %>% 
  arrange(n) %>% 
  mutate(CVG_type=factor(CVG_type, levels=unique(CVG_type))) %>% 
  select(-n)

rowanno <- rowanno %>%
  mutate(CVG_type=factor(CVG_type, levels=unique(gap_index$CVG_type))) %>%
  arrange(CVG_type)

gene_order <- rownames(rowanno)
rowanno <- rowanno %>% 
  HeatmapAnnotation(df = . , which = "row",
                    col = list(CVG_type=ggpubr::get_palette(palette = "npg", 6) %>%
                                        set_names(unique(rowanno$CVG_type))))

# pdf("figures/uncorrected/cvgs_pexel/CGVs_timepoints_D456_log2TPM_heatmap.pdf", height = 12, width = 12)
mat <- mat[gene_order, ] 
heat_colors <- circlize::colorRamp2(breaks=c(0,1,3,6,9), colors = viridis::turbo(5))

# svglite::svglite("figures/uncorrected/cvgs_pexel/CGVs_timepoints_D456_log2TPM_heatmap.svg",fix_text_size=FALSE, system_fonts = list(sans = "Open Sans"), height = 12, width = 12)
Heatmap(matrix = mat, 
        col = heat_colors,
        name = "log2 TPM",
        split = gap_index,
        top_annotation = colanno, 
        left_annotation = rowanno, 
        column_dend_reorder =  rep(1:3,each = 3), 
        column_names_gp = gpar(fontsize=14),
        show_column_names = TRUE,
        show_row_names = TRUE,
        row_title_gp = gpar(fontsize = 14),
        row_title_rot = 0,
        row_names_gp = gpar(fontsize = 6)
        )
# dev.off()
```

# Search for PEXEL 

From PlasmoDB
Pexel genes: 
 R at position 1, any charge-neutral amino acid at position 2, L at position 3, any charge-neutral amino acid at position 4, and E, D, or Q at position 5 (R.L.E/D/Q),
 
PlasmoDB search: 
 Pattern	RXLX[EQD]
Organism	Plasmodium falciparum 3D7

```{r}
#For comparison from PlasmoDB
pexel_genes <- read.delim("expression_data/gene_annots/PEXEL_canonical_motif_TranscriptRecordClass_Summary.txt") %>% 
  janitor::clean_names()

head(pexel_genes)
dim(pexel_genes) #1,437   11
```

```{r eval=FALSE}
# For comparison 
nc_pexel_motifs <- tabulizer::extract_tables("references/PEXEL/mmi13024_supplemental_table2.pdf")

nc_pexel_motifs_clean <- purrr::map(nc_pexel_motifs, function(x){
  df <- as.data.frame(x) 
  df %>%
    rename_all(~c("gene_id","description","motif")) %>%
    mutate(type="non-canonical")
}) %>% 
  bind_rows()

nc_pexel_motifs_clean %>% 
  filter(gene_id != "") %>% 
  pull(gene_id) %>% 
  unique() %>%
  length() #388 
```

```{r}
pexel_motifs <- data.frame(type=c("Canonical", rep("non-canonical",5)),
                           motif=c("R.L.E/D/Q","R.I.E/D/Q","K.L.E/D/Q",
                                   "H.L.E/D/Q","H.I.E/D/Q","A.L.E/D/Q"),
                           motif_regex=c("R.L.[EDQ]","R.I.[EDQ]","K.L.[EDQ]",
                                   "H.L.[EDQ]","H.I.[EDQ]","A.L.[EDQ]")) %>% 
  mutate(motif_name=paste0(tolower(type),"_",motif) %>% 
           gsub("[-\\.\\/]","", .))

pexel_motifs
# write.csv(pexel_motifs, "results/cvgs_pexel_domains/pexel_motifs.csv", row.names = FALSE)
```

```{r}
# 150 aa
aa_lengths <- width(proteins_aa) 
ok_len <- aa_lengths >= 150
nterm_150aa <- proteins_aa[ok_len] %>% 
  narrow(., start = 1, width = 150) 
short_aa <- proteins_aa[!ok_len] %>% 
  narrow(., start = 1, width = aa_lengths[!ok_len])
nterm_150aa <- c(nterm_150aa, short_aa)

# 100 as
trimmed_aa_lens <- width(nterm_150aa)
ok_100_len <- trimmed_aa_lens >= 100
nterm_100aa <- nterm_150aa[ok_100_len] %>% 
  narrow(., start = 1, width = 100)
short_100aa <- nterm_150aa[!ok_100_len] %>% 
  narrow(., start = 1, width = trimmed_aa_lens[!ok_100_len]) 
nterm_100aa <- c(nterm_100aa, short_100aa)
names(nterm_100aa) <- gsub("^(PF3D7.+p[0-9])\\s.+","\\1",names(nterm_100aa))
# Biostrings::writeXStringSet(nterm_100aa, filepath = "results/cvgs_pexel_domains/PF3D7_100aa_nterm_protein.fasta")
```

```{r eval=FALSE}
pexel_motif_patterns <- pull(pexel_motifs, motif_regex, name = motif_name)

pexel_hits <- purrr::map(.x = pexel_motif_patterns, 
                         .f = aa_motif_search, 
                         aa_to_search = nterm_150aa)

lapply(pexel_hits, head)
lapply(pexel_hits, dim)

# saveRDS(pexel_hits,"results/cvgs_pexel_domains/pexel_motif_search_150aa_results_list.RDS")


new_col_names <- lapply(pexel_motifs$motif_name, 
                        function(x) paste(c("n_matches","match","position"), x, sep="_")) %>%
  unlist()

pexel_hits_all <- purrr::reduce(pexel_hits, left_join, by="aa_name") %>%
  rename_at(vars(matches("match|position")), ~new_col_names)

# write.csv(pexel_hits_all, "results/cvgs_pexel_domains/pexel_motif_search_150aa_results.csv")
```

```{r}
pexel_hits_all <- read.csv("results/cvgs_pexel_domains/pexel_motif_search_150aa_results.csv", row.names = 1)


head(pexel_hits_all)
dim(pexel_hits_all) #5389   19

# pexel_hits_all[,grep("n_matches", colnames(pexel_hits_all))] %>%
#   sapply(., table)
```

```{r}
pexel_hits_bool <- pexel_hits_all %>% 
  select(aa_name, matches("n_matches")) %>%
  mutate(transcript_id=gsub("\\.p[0-9]","", aa_name),
         gene_id=gsub("\\.[0-9]+","",transcript_id)) %>% 
  select(gene_id,
         matches("n_matches")) %>%
  group_by(gene_id) %>% 
  mutate(across(matches("n_matches"), .fns = sum)) %>% 
  ungroup() %>% 
  distinct() %>% 
  pivot_longer(cols=matches("n_matches"),
               names_to = "type",
               values_to = "n_matches") %>%
  mutate(type=gsub("n_matches_","",type) %>%
           gsub("ical", "",.),
         has_pexel_domain=n_matches>0) %>% 
  group_by(gene_id) %>%
  mutate(any_pexel_domain=any(has_pexel_domain)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(gene_id,any_pexel_domain),
              names_from = type,
              values_from = has_pexel_domain,
              names_glue = "{.value}_{type}")

pexel_hits_bool %>% head #5,318
# table(duplicated(pexel_hits_bool$gene_id)) # FALSE
# table(pexel_hits_bool$any_pexel_domain) #2346
table(pexel_hits_bool$has_pexel_domain_canon_RLEDQ) #669 genes
```

```{r}
# pexel_hits_bool
chk <- pexel_hits_all %>% 
  mutate(gene_id=gsub("\\.[0-9]+.+","",aa_name)) %>% 
  filter(n_matches_canonical_RLEDQ > 0) %>% 
  select(gene_id, aa_name, n_matches_canonical_RLEDQ)

length(unique(chk$gene_id))
length(unique(chk$aa_name))
```

```{r}
pexel_hits_table <- purrr::map_dfr(.x = colnames(pexel_hits_bool[,-1]), 
                .f = function(x){
                  table(pexel_hits_bool[[x]]) %>% 
                     as.data.frame() %>% 
                     mutate(type=x)
                }) %>% 
  group_by(type) %>% 
  mutate(percent=round(Freq / sum(Freq) *100, digits = 2)) %>% 
  ungroup() %>% 
  mutate(Var1=tolower(Var1)) %>% 
  rename_at(vars(Freq), ~c("number")) %>% 
  pivot_wider(id_cols=type, 
              names_from=c(Var1), 
              values_from=c(number, percent)) %>% 
  mutate(total=nrow(pexel_hits_bool)) %>% 
  select(type, matches("true"), everything())

# write.csv(pexel_hits_table, "results/cvgs_pexel_domains/pexel_motif_hits_150aa_summary_table.csv", row.names = F)
```

```{r}
input <- pexel_hits_bool %>% 
  filter(any_pexel_domain) %>% 
  select(gene_id, matches("has_pexel")) %>% 
  mutate_at(vars(matches("has_pexel")), ~as.numeric(.)) %>%
  as.data.frame()

# input

# pdf("figures/uncorrected/cvgs_pexel/pexel_motif_genes_150aa_upset.pdf", height = 5, width = 8)
UpSetR::upset(data=input,
              nintersects = NA,
              order.by=c("freq","degree"),
              group.by = "degree")
# dev.off()
```

```{r}
# table(input$has_pexel_domain_canon_RLEDQ)
```

### PTEX Gene Expression 

-	EXP2 (PF3D7_1471100)
-	PTEX 150 (PF3D7_1436300)
-	HSP101 (PF3D7_1116800)
-	TRX2 (PF3D7_1345100)
-	PTEX 88 (PF3D7_1105600)

```{r}
ptex_ids <- c("PF3D7_1471100","PF3D7_1436300","PF3D7_1116800","PF3D7_1345100","PF3D7_1105600")

samples_include <- pf_samples %>% 
  filter(!grepl("Day[02]", time_point))

table(samples_include$analysis_factor_group)
```

```{r}
# ptex_expn <- log2(assay(cb_se,"cpm")+1)
rownames(TPM) <- TPM$gene_name
log2_TPM_expn <- log2(TPM[,samples_include$sample_id_cat]+1)
include <- base::intersect(ptex_ids, rownames(log2_TPM_expn))
ptex_expn <- log2_TPM_expn[include,]
head(ptex_expn[,1:5])
# dim(ptex_expn) 
```

```{r}
ptex_expn_long <- ptex_expn %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  pivot_longer(cols = -gene_id,
               names_to = "sample_id_cat",
               values_to = "log2TPM") %>% 
  inner_join(., pf_samples, by="sample_id_cat") %>%
  select(gene_id:log2TPM, everything())

head(ptex_expn_long)
```

```{r fig.width=5, fig.height=3}
labels <- c("PF3D7_1471100"="EXP2","PF3D7_1436300"="PTEX150", "PF3D7_1116800"="HSP101", "PF3D7_1345100"="TRX2", "PF3D7_1105600"="PTEX88")

set.seed(202)

# svg("figures/uncorrected/cvgs_pexel/PTEX_complex_genes_expression_boxplot.svg", height = 5, width = 10)
ggplot(ptex_expn_long, aes(x=gene_id, y=log2TPM, fill=gene_id)) +
  geom_boxplot(alpha=0.75, color="grey60") +
  facet_wrap(~analysis_factor_group) +
  geom_point(
             aes(color=analysis_factor_group),
             position = position_jitterdodge(jitter.width = 0.25, jitter.height = 0),
             size=2, alpha=0.75) +
  # scale_color_viridis_d(begin=0,end=0.8,direction = -1) +
  scale_color_manual(values=ggpubr::get_palette("Blues", 4)[2:4]) +
  scale_fill_viridis_d(begin=0,end=0.8,
                        direction = -1,
                        option = "A",
                        labels=labels) +
  scale_x_discrete(labels = labels) +
  guides(fill = guide_legend(override.aes = list(size = 0, alpha=0.75) )) +
  labs(x="") +
  theme_classic() +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
# dev.off()


```

```{r}
labels <- c("PF3D7_1471100"="EXP2","PF3D7_1436300"="PTEX150", "PF3D7_1116800"="HSP101", "PF3D7_1345100"="TRX2", "PF3D7_1105600"="PTEX88")


summary_ptex_expn <- ptex_expn_long %>% 
  group_by(time_point,gene_id) %>% 
  summarise(median=median(log2TPM), 
            sd=sd(log2TPM), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  arrange(gene_id)

# head(summary_ptex_expn)

set.seed(123)
pd <- position_dodge(width = 0.5)

# svg("figures/uncorrected/cvgs_pexel/PTEX_complex_genes_expression_lineplot.svg", height = 5, width = 7)
ggplot(summary_ptex_expn, aes(x=time_point, y=median, group=gene_id)) +
  geom_line(aes(color=gene_id), alpha=0.8, 
            position = pd) +
  geom_point(aes(color=gene_id), 
             alpha=0.8, size=2.5,
             position = pd) + 
  geom_errorbar(aes(ymin=median-sd, ymax=median+sd, color=gene_id),
                width=0.25,
                alpha=0.5, 
                position = pd) +
  labs(x="",y="log2 TPM") +
  scale_color_viridis_d(begin=0,end=0.8,direction = -1, option = "A", 
                        labels=labels) +
  theme_classic()
# dev.off()
```


### PEXEL Gene Expression

```{r}
samples_include <- pf_samples %>% 
  filter(!grepl("Day[02]", time_point))


pexel_genes_ided <- pexel_hits_bool$gene_id[pexel_hits_bool$any_pexel_domain]
# length(pexel_genes_ided)

# non-log expression 
include_pexel <- base::intersect(pexel_genes_ided, rownames(TPM))
pexel_expn <- TPM[include_pexel, samples_include$sample_id_cat]

head(pexel_expn[,1:5])
# dim(pexel_expn) #2346
```

```{r}
pexel_expn_long <- pexel_expn %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  pivot_longer(cols = -gene_id,
               names_to = "sample_id_cat",
               values_to = "TPM") %>% 
  inner_join(., pf_samples, by="sample_id_cat") %>%
  select(gene_id:TPM, everything())

# head(pexel_expn_long)
table(pexel_expn_long$analysis_factor_group)
```

```{r}
expn_to_add <- pexel_expn %>% 
  rownames_to_column("gene_id") %>% 
  rename_at(vars(-gene_id), ~samples_include$analysis_group_id %>% 
              gsub("_Heps|_Pf\\+", "", .) %>% 
              paste0(.,"_TPM"))

# expn_to_add %>% head()
```

```{r}
pexel_hits_all_toAdd <- pexel_hits_all %>% 
  mutate(gene_id=gsub(".[0-9].p[0-9]","", aa_name)) %>% 
  select(gene_id, aa_name, everything())

# head(pexel_hits_all_toAdd)
dim(pexel_hits_all_toAdd)
table(pexel_hits_all_toAdd$n_matches_canonical_RLEDQ)
```

```{r}
pexel_summary_stats <- pexel_expn_long %>% 
  mutate(expression_boolean = TPM >= 1.0)  %>% 
  group_by(time_point, gene_id) %>% 
  summarise(number_samples_expressing_GT1.0_TPM=sum(expression_boolean), 
         mean_TPM=mean(TPM), 
         median_TPM=median(TPM), 
         sd_TPM=sd(TPM), 
         .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols=gene_id,
              names_from = time_point, 
              values_from = c(number_samples_expressing_GT1.0_TPM:sd_TPM),
              names_glue = "{time_point}_{.value}") %>% 
  rowwise() %>% 
  mutate(total_samples_expressing_GT1.0_TPM = sum(c_across(matches("number_samples_expressing")))) %>% 
  ungroup() %>% 
  left_join(pexel_hits_all_toAdd, by="gene_id") %>% 
  left_join(., expn_to_add, by="gene_id") %>% 
  select(gene_id, total_samples_expressing_GT1.0_TPM, 
         matches("canonical_RLEDQ"), 
         everything())  %>% 
  arrange(desc(total_samples_expressing_GT1.0_TPM), 
          desc(n_matches_canonical_RLEDQ))


pexel_summary_stats
# write.csv(pexel_summary_stats, "results/cvgs_pexel_domains/pexel_motif_hits_150aa_expression_TPM.csv", row.names = FALSE)
```


#### Canonical PEXELs Expression threshold

```{r}
pexel_expn_threshold_1TPM <- pexel_summary_stats %>% 
  filter(n_matches_canonical_RLEDQ > 0 ) %>% 
  mutate(passed_threshold=case_when(
    Day4_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
    Day5_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
    Day6_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
    TRUE ~ "No"
  )) %>% 
  left_join(., PF3D7_gene_annots, by="gene_id") %>% 
  select(aa_name, gene_name, passed_threshold, 
         gene_id:position_canonical_RLEDQ,
         matches("Day[0-9]_number_samples_expressing"),
         seqnames:strand, description) 

dim(pexel_expn_threshold_1TPM)
table(pexel_expn_threshold_1TPM$passed_threshold)
#  No Yes 
# 302 380 
```

```{r fig.height=20, fig.width=12}

colanno_df <- sel_samps %>% 
  filter(time_point != "Day0") %>% 
  select(time_point = analysis_factor_group, 
         sample_id_cat) 

canon_gene_ids <- pexel_hits_bool$gene_id[pexel_hits_bool$has_pexel_domain_canon_RLEDQ]

colanno <-  HeatmapAnnotation(df = select(colanno_df, -sample_id_cat),
                    which = "column",
                    col = list(time_point=ggpubr::get_palette("jco",3) %>%
                                          set_names(unique(colanno_df$time_point))))
rowanno_df <- pexel_expn_threshold_1TPM %>% 
  mutate(label=case_when(
    !grepl("PF3D7", gene_name) ~ paste(gene_id,gene_name,sep=": "), 
    TRUE ~ gene_id)) %>% 
  select(label,gene_id, passed_threshold) %>% 
  distinct()

rowanno <- rowanno_df %>% 
  select(label, passed_threshold) %>%
  column_to_rownames("label") %>% 
  as.data.frame() %>% 
  HeatmapAnnotation(df = . , 
                    which = "row",
                    col = list(passed_threshold=ggpubr::get_palette(palette = "npg", 2) %>%
                                        set_names(unique(rowanno_df$passed_threshold))))


heat_colors <- circlize::colorRamp2(breaks=c(0,1,3,6,9,12), colors = viridis::turbo(6))
mat <- as.matrix(log2(pexel_expn[rowanno_df$gene_id, colanno_df$sample_id_cat]+1) )
colnames(mat) <- colanno_df$analysis_group_id
rownames(mat) <- rowanno_df$label

# svglite::svglite("figures/uncorrected/cvgs_pexel/PEXEL_canonical_timepoints_D456_log2TPM_heatmap.svg",fix_text_size=FALSE, system_fonts = list(sans = "Open Sans"), height = 12, width = 10)
Heatmap(matrix = mat, 
        col = heat_colors,
        name = "log2 TPM",
        top_annotation = colanno, 
        left_annotation = rowanno,
        show_column_names = TRUE,
        show_row_names = FALSE,
        column_dend_reorder = rep(1:3, each = 3),
        row_title_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize=6),
        row_names_gp = gpar(fontsize = 2))
# dev.off()
```

```{r}
pexel_filtered_1TPM <- pexel_expn_threshold_1TPM %>% 
  filter(passed_threshold == "Yes") %>% 
  select(aa_name,gene_name, gene_id, 
         position_canonical_RLEDQ, match_canonical_RLEDQ, n_matches_canonical_RLEDQ) %>% 
  separate(position_canonical_RLEDQ, into=paste0("hit",1:3), sep="; ", remove = FALSE, fill = "right") %>% 
  pivot_longer(., cols = c(hit1:hit3), names_to="number_pexel_hits", values_to = "position") %>% 
  filter(!is.na(position)) %>% 
  separate(position, into=c("start", "end"), sep="-") %>% 
  mutate_at(vars(start,end), ~as.numeric(.)) %>% 
  mutate(seqnames=aa_name)  %>% 
  arrange(seqnames) %>% 
  select(seqnames, start, end, everything(), -number_pexel_hits)
  # plyranges::as_granges()

# pexel_filtered_1TPM
```

### Non-Canonical 

```{r}
cols <- grep("n_matches_noncanonical", colnames(pexel_summary_stats), value = T)
cols
```

```{r}
pexel_noncanon_1TPM_dfs <- purrr::map(cols, function(x){
  
  motif <- str_split_fixed(x, "_", n=4)[,4]
  
  pexel_summary_stats %>% 
    filter(!! as.name(x) > 0 ) %>% 
    mutate(passed_threshold=case_when(
      Day4_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
      Day5_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
      Day6_number_samples_expressing_GT1.0_TPM == 3 ~ "Yes",
      TRUE ~ "No"
    )) %>%
    left_join(., PF3D7_gene_annots, by="gene_id") %>%
    mutate(pexel_motif = motif) %>% 
    select(pexel_motif, 
           aa_name, gene_name, passed_threshold,
           gene_id, matches(motif),
           matches("Day[0-9]_number_samples_expressing"),
           seqnames:strand, description, 
           matches("Day[0-9]_S[0-9]_TPM"))
})
names(pexel_noncanon_1TPM_dfs) <- str_split_fixed(cols, "_", n=4)[,4]
```





# SignalP Results

```{bash eval=FALSE}
qsub references/signalp.pbs
```

```{r}
known_exported <- read.csv("references/PEXEL/export proteins from PlasmoDB.csv") %>% 
  janitor::clean_names() %>% 
  mutate(has_signal_pep=!grepl("N\\/A", signal_p_peptide))

head(known_exported)
table(known_exported$has_signal_pep)
# FALSE  TRUE 
#   257   165 

dim(known_exported)
# table(duplicated(known_exported$gene_id))
# length(unique(known_exported$gene_id))
```


`prediction_results.txt`
A tab delimited file with one line per prediction. 
Columns:  
- ID: the sequence ID parsed from the fasta input.
- Prediction: The predicted type. One of [`OTHER` (No SP), `SP` (Sec/SPI), `LIPO` (Sec/SPII), `TAT` (Tat/SPI), `TATLIPO` (Tat/SPII), `PILIN` (Sec/SPIII)].
- One column for each possible type with the model's probability.
- CS Position: The cleavage site. The sequence positions between which the SPase cleaves and its predicted probability.


```{r}
signalp_res <- read.delim("results/cvgs_pexel_domains/signalp6.0/prediction_results.txt", sep='\t', comment.char = "#", header = FALSE) %>% 
  rename_all(~c("id","prediction_type","prob_other","prob_signal_pep","cleavage_site_position")) %>% 
  arrange(desc(prob_signal_pep)) %>% 
  mutate(gene_id=gsub("\\.[0-9]-p[0-9]$","", id), 
         transcript_id=gsub("-p[0-9]$","", id)) %>% 
  left_join(.,select(PF3D7_gene_annots,gene_id, gene_name, description), by="gene_id")

signalp_res %>% head()
dim(signalp_res)
# length(unique(signalp_res$gene_id))
# write.csv(signalp_res,"results/cvgs_pexel_domains/signalp6.0/prediction_results_annotated.csv", row.names = FALSE)
```

`output.gff3`
The start and end positions of all predicted signal peptides in GFF3 format.

```{r}
signalp_gtf <- rtracklayer::import("results/cvgs_pexel_domains/signalp6.0/output.gff3") %>% 
  as.data.frame() %>% 
  mutate(seqnames=gsub("\\-",".", seqnames)) %>% 
  arrange(desc(score)) %>% 
  mutate(gene_id=gsub("\\.[0-9]\\.p[0-9]$","", seqnames)) %>% 
  left_join(.,select(PF3D7_gene_annots,gene_id, gene_name, description), by="gene_id")


signalp_gtf %>% head() #597 seq
# table(end(signalp_gtf)) # all are less 100amino acids  
# table(start(signalp_gtf))

# quantile(signalp_gtf$score)
#        0%       25%       50%       75%      100% 
# 0.5000094 0.8330923 0.9996170 0.9998040 1.0000316 
length(unique(signalp_gtf$gene_id))
```

```{r}
# table(known_exported$gene_id %in% signalp_gtf$gene_id)
# FALSE  TRUE 
#   296   126

# table(known_exported$has_signal_pep)

comparison_signalP <- known_exported %>% 
  left_join(., signalp_gtf, by="gene_id", multiple='all') %>% 
  mutate(source=as.character(source)) 


comparison_signalP %>% 
  group_by(has_signal_pep, source) %>% 
  dplyr::count() %>% 
  ungroup() %>% 
  mutate(source=ifelse(is.na(source), "plasmoDB", source)) 
# %>% View()

# 116/165*100 == 70% identified by signalP 6.0

diff <- comparison_signalP %>% 
  filter(has_signal_pep, 
         is.na(source)) %>% 
  rename_at(vars(signal_p_peptide:has_signal_pep),
            ~paste0(.,"_signalPv3.0")) %>% 
  left_join(., select(signalp_res, id, transcript_id, prediction_type:cleavage_site_position) %>% 
              rename_at(vars(prediction_type:cleavage_site_position), ~paste0(.,"_signalPv6.0")),
            by=c("source_id"="transcript_id")) %>% 
  arrange(desc(prob_signal_pep_signalPv6.0)) %>% 
  select(gene_id:has_signal_pep_signalPv3.0, 
         id:cleavage_site_position_signalPv6.0)

# diff
# write.csv(diff,"results/cvgs_pexel_domains/PF3D7_signalPv3.0_vs_signalPv6.0.csv", row.names = F)
```

# Integrate SignalP and TM domains

### Canonical 

```{r}
signalp_pexel_results <- signalp_gtf %>% 
  select(-gene_id, -gene_name) %>% 
  inner_join(., pexel_filtered_1TPM, by="seqnames", suffix=c("_signalP","_pexel")) %>% 
  arrange(desc(score)) %>% 
  mutate(distance_SP_pexel=end_pexel-end_signalP) 

subset_summary <- select(pexel_summary_stats, gene_id, matches("TPM")) %>% 
  filter(gene_id %in% signalp_pexel_results$gene_id) %>% 
  distinct()

signalp_pexel_results <- signalp_pexel_results %>% 
  left_join(., subset_summary, by="gene_id") %>% 
  select(seqnames, gene_id, gene_name, 
         distance_SP_pexel,
         score,
         matches("start|end"), 
         everything())

dim(signalp_pexel_results)
length(unique(signalp_pexel_results$gene_id)) #35 gene_ids

# write.csv(signalp_pexel_results, "results/cvgs_pexel_domains/canonical_pexel_motif_hits_150aa_signalP_hits_100aa_expression_TPM.csv", row.names = FALSE)
```

### Non-canonical 

```{r}
noncanon_pexel_signalp <- purrr::map(pexel_noncanon_1TPM_dfs, function(df){
  n <- max(df[,grep("n_matches",colnames(df))])
  print(unique(df[["pexel_motif"]]))
  
  df <-   df %>% 
    filter(passed_threshold == "Yes") %>% 
    select(pexel_motif, 
           aa_name,
           gene_name,
           gene_id, 
           matches("position_noncanonical|match_noncanonical|n_matches_noncanonical"),
           matches("TPM")) %>% 
    separate(matches("position_noncanonical"), into=paste0("hit",1:n), sep="; ", remove = FALSE, fill = "right") %>% 
    pivot_longer(., cols = matches("hit[0-9]"), names_to="number_pexel_hits", values_to = "position") %>% 
    filter(!is.na(position)) %>% 
    separate(position, into=c("start", "end"), sep="-") %>% 
    mutate_at(vars(start,end), ~as.numeric(.)) %>% 
    mutate(seqnames=aa_name)  %>% 
    arrange(seqnames) %>% 
    select(seqnames, start, end, everything(),
           -number_pexel_hits)
  
  print(length(unique(df$gene_id)))
  
  signalp_pexel_results <- signalp_gtf %>%
    select(-gene_id, -gene_name) %>%
    inner_join(., df, by="seqnames", suffix=c("_signalP","_pexel")) %>%
    arrange(desc(score)) %>%
    mutate(distance_SP_pexel=end_pexel-end_signalP) %>%
    select(pexel_motif, seqnames, gene_id, gene_name,
         distance_SP_pexel,
         score,
         matches("start|end"),
         everything())
      
})
names(noncanon_pexel_signalp) <- names(pexel_noncanon_1TPM_dfs)
```

```{r}
# lapply(noncanon_pexel_signalp, head)

sapply(noncanon_pexel_signalp, function(x) length(unique(x$gene_id))) %>% 
  set_names(., names(noncanon_pexel_signalp))
```

```{r}
# lapply(names(noncanon_pexel_signalp), function(x) write.csv(noncanon_pexel_signalp[[x]],
#   glue::glue("results/cvgs_pexel_domains/noncanonical_pexel_motif_{x}_hits_150aa_signalP_hits_100aa_expression_TPM.csv"), row.names = FALSE))
```


# Venn Diagram

```{r}
library(ggVennDiagram)
library(eulerr)
```

```{r}
table(samples_include$analysis_factor_group)
```

```{r}
summary_expressed_1TPM <- TPM[,c("gene_name", samples_include$sample_id_cat)] %>% 
  filter(!gene_name %in% mito_genes$gene_id) %>% 
  pivot_longer(cols = -gene_name,
               names_to="sample_id_cat",
               values_to = "TPM") %>% 
  inner_join(samples_include, by="sample_id_cat") 

any_expressed_1TPM <- summary_expressed_1TPM %>% 
  arrange(gene_name) %>% 
  group_by(analysis_factor_group, gene_name) %>%
  reframe(expression_GT.1TPM = sum(TPM > 1.0) == 3) %>%
  ungroup() %>%
  arrange(gene_name) %>% 
  filter(expression_GT.1TPM)


# head(any_expressed_1TPM)
# tail(any_expressed_1TPM)
length(unique(any_expressed_1TPM$gene_name)) #4743
```

## Canonical 

```{r}
pexel_ids <- pexel_hits_bool$gene_id[pexel_hits_bool$has_pexel_domain_canon_RLEDQ] %>% unique()
expn_1TPM_ids <- any_expressed_1TPM %>% pull(gene_name) %>% unique()
signal_p_ids <- signalp_gtf$gene_id %>% unique()

gene_lists <- list(pexel_ids=pexel_ids, expn_1TPM_ids=expn_1TPM_ids, signal_p_ids=signal_p_ids)
sapply(gene_lists, length)
```

```{r fig.height=7, fig.width=7, eval=FALSE}
# svglite::svglite("figures/uncorrected/cvgs_pexel/canonical_pexel_signalP_expression_1TPM_venn.svg", height = 10, width = 10, fix_text_size=FALSE, system_fonts = list(sans = "Open Sans"))
ggVennDiagram(gene_lists,
              label_alpha=0.75,
              label_geom = "label",
              set_size=3, 
              label_size=7) + 
  scale_color_manual(values=c(viridis::mako(n = 3, end = 0.8))) +
  # scale_fill_gradient()
  scale_fill_gradient(low = "deepskyblue3", high =  "aliceblue",
                      name="Number of Genes")
# dev.off()
```

```{r}
fit <- euler(gene_lists, shape = "circle")

fit$diagError
fit$stress

# svg("figures/uncorrected/cvgs_pexel/canonical_pexel_signalP_expression_1TPM_euler.svg", height = 5, width = 5)
plot(fit, labels = TRUE, quantities = TRUE,
     main = "canonical pexel motif genes", 
     fills = RColorBrewer::brewer.pal(3,"Blues"))
# dev.off()
```

# Share the Data 

```{r}
pf_samples_supplement <- pf_samples %>% 
    mutate(manuscript_sample_id=gsub("sporozorite","sporozoites",analysis_group_id) %>% 
                gsub("Heps","Pf_LS", .) %>% 
                gsub("^(.+_)[S]([0-9]).{0,}","\\1Rep\\2", .)) %>% 
  select(sample_id_cat, manuscript_sample_id,
         everything(),
         -analysis_group_id)

# dim(pf_samples_supplement)
# write.csv(pf_samples_supplement,"references/Paper_Versions/kappe_s_Pf_liver_stage_rnaseq_sample_manifest.csv", row.names=FALSE)
```

```{r}
TPM_supplement <- TPM[,c("gene_name",pf_samples_supplement$sample_id_cat)]
head(TPM_supplement)

# dim(TPM_supplement) #5720   18
# write.csv(TPM_supplement, "references/Paper_Versions/kappe_s_Pf_liver_stage_rnaseq_TPM.csv", row.names=FALSE)
```


```{bash}
./rsync.sh
```


# Session Information 

```{r}
sessionInfo()
```

