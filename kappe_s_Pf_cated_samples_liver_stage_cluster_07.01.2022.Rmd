---
title: "Clustering Concatenated Bio/Tech Replicates - EDA"
author: "Jenny L Smith"
date: "`r Sys.Date()`"
output: html_document
---

# Set-up 

```{r set-up}
knitr::opts_knit$set(root.dir = PROJHOME)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=50),
                      tidy=TRUE,
                      fig.align='center',
                      fig.width = 10, fig.height = 10)

options(stringsAsFactors = FALSE, max.print = 100)
table = function (..., useNA = 'ifany') base::table(..., useNA = useNA)
```

```{r message = FALSE, warning=FALSE}
library(tidyr)
library(tibble)
library(magrittr)
library(dplyr)
library(stringr)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(patchwork)

getwd()
```

# Define Functions 


```{r}
create_long_format_dfs <- function(species_genes,sample_manifest_cated,
                                   counts_matrix_cated, TMMCPM){
  CPM_matrix_anno <- species_genes %>% 
    inner_join(., rownames_to_column(TMMCPM,"gene_id"),
              by="gene_id") %>% 
    pivot_longer(cols = all_of(sample_manifest_cated$sample_id_cat),
                 names_to="sample_id_cat",
                 values_to="TMMCPM") %>% 
    inner_join(., sample_manifest_cated, by="sample_id_cat")

  counts_matrix_cated_anno <- species_genes %>% 
    inner_join(., counts_matrix_cated,
              by="gene_id") %>% 
    pivot_longer(cols = all_of(sample_manifest_cated$sample_id_cat),
                 names_to="sample_id_cat",
                 values_to="counts") %>% 
    inner_join(., sample_manifest_cated, 
               by="sample_id_cat")
  
  return(list("CPM_anno"=CPM_matrix_anno,
              "counts_anno"=counts_matrix_cated_anno,
               "counts"=counts_matrix_cated,
              "TMMCPM"=TMMCPM))
}
```

```{r}
#from https://github.com/mikelove/DESeq2/blob/master/R/plots.R
#Want to return the whole scores matrix so can examine 3d pca plots. 
plotPCA.DESeq.mod <- function(object, intgroup="condition", ntop=500, returnData=FALSE, PC3=FALSE)
{
  library(matrixStats)
  # calculate the variance for each gene
  rv <- rowVars(assay(object))
  
  # select the ntop genes by variance
  select <- order(rv, decreasing=TRUE)[seq_len(min(ntop, length(rv)))]
  
  # perform a PCA on the data in assay(x) for the selected genes
  pca <- prcomp(t(assay(object)[select,]))
  
  # the contribution to the total variance for each component
  percentVar <- pca$sdev^2 / sum( pca$sdev^2 )
  
  if (!all(intgroup %in% names(colData(object)))) {
    stop("the argument 'intgroup' should specify columns of colData(dds)")
  }
  
  intgroup.df <- as.data.frame(colData(object)[, intgroup, drop=FALSE])
  
  # add the intgroup factors together to create a new grouping factor
  group <- if (length(intgroup) > 1) {
    factor(apply( intgroup.df, 1, paste, collapse=":"))
  } else {
    colData(object)[[intgroup]]
  }
  
  # assembly the data for the plot - first 10 PCs
  # d <- data.frame(PC1=pca$x[,1], PC2=pca$x[,2], group=group, intgroup.df, name=colnames(object))
  n <- min(10, ncol(as.data.frame(pca$x)))
  d <- data.frame(as.data.frame(pca$x)[,1:n], group=group, intgroup.df, name=colnames(object))
  
  if (returnData) {
    attr(d, "percentVar") <- percentVar[1:10]
    rot <- pca$rotation[,1:10] #for first 10 PCs
    dat <- list("scores"=d,"rotation"=rot)
    return(dat)
  }
}

#Updated on 6/9/17 to use variance stabilized transformed data as input (not center scaled log2, like in princomp)
PCA <- function(expnData,phenovector,
                title="",round=TRUE,colorCodes=NULL,
                ntop=500, GOI=NULL){
  
  suppressPackageStartupMessages(library(DESeq2))
  library(ggplot2)
  #expnData is the raw counts (not normalized) has patient IDs as colnames and genes as rownames. 
  
  samples <- intersect(names(phenovector), colnames(expnData))
  countData <- expnData[,samples]
  phenovector <- phenovector[samples]
  colData <- as.data.frame(phenovector)
  
  if(round){
    countData <- round(countData, digits = 0)
  }
  
  #Create as DESeq data set object (dds)
  dds <- DESeqDataSetFromMatrix(countData = countData,
                                  colData = colData,
                                  design = ~ 1)
  
  #perform variance stabilized transformation 
  dds <- dds[ rowSums(counts(dds)) > 10, ]
  varianceStab <- vst(dds, blind = TRUE)
  
  #if given a list of genes of interest
  if (! is.null(GOI)){
    GOI <- intersect(GOI, rownames(assay(varianceStab)))
  }else{
    GOI <- 1:nrow(varianceStab)
  }
  
  #PCA data frame with the wieghts/loadings and eigen vectors
  pca.dat <- plotPCA.DESeq.mod(varianceStab[GOI,], 
                               intgroup = "phenovector", 
                               ntop = ntop,
                               returnData=TRUE)
  
  plots <- lapply(c(2:3), function(pc){
      percentVar <- attr(pca.dat$scores, which="percentVar")
      y_var <- paste0("PC",pc)
      
      p <- ggplot(data=pca.dat$scores, 
             aes_string(x="PC1", y=y_var, color="phenovector")) + 
        geom_point(size=3, alpha=0.75) +
        xlab(paste0("PC1: ",round(percentVar[1] * 100),"% variance")) +
        ylab(paste0(y_var,": ",round(percentVar[pc] * 100),"% variance")) +
        labs(title=title) +
        theme_classic() +
        theme(legend.position = "top")
      if(!is.null(colorCodes)){
        p <- p + 
          scale_color_manual(values=colorCodes)
      }
      return(p)
  })
  
  #Final Results object
  res <- list(dds, varianceStab,pca.dat, plots)
  names(res) <- c("dds", "vst","pca_data","pca_plots")
  
  if(is.character(GOI)){
    res[["GOI"]] <- GOI
  }
  
  return(res)
}
```

```{r}
#changed on 2/14/18, see bottom of Heatmaps_Function.r for the original one used.
dge_dendrograms <- function(expnData, pheno, method,
                            genelist=NULL,add.count=1, percent=0.05,
                            ntop=500,filterTopGenes=FALSE, createDGE=TRUE,log=FALSE){
  #df with count data, patient IDs are column names and rows are genes.
  #pheno is a character vector with patient IDs as names, and the status for each in each group (eg pos,neg)
  #genelist is a character vector with the genes of interest
  #percent is the % of samples in the input expn matrix that must express a gene at 1 CPM. Filter to remove low count genes.
  #set log=TRUE if providing a log2 expression dataframe.
  #filterTopGenes shuold be a logical. If TRUE filter top 1000 most varied genes.
  suppressPackageStartupMessages(require(edgeR))
  suppressPackageStartupMessages(library(dendextend))
  suppressPackageStartupMessages(library(matrixStats))

  expnData <- expnData[, intersect(names(pheno), colnames(expnData))] #ensure correct order, drop rows with nas just in case
  if(createDGE){
    dge <- DGEList(counts = expnData)
    #keep the rows (genes) with at least 1 CPM in a minimum of 2 samples or X% of samples. 
    keep.dge <- rowSums(cpm(dge) >= 1) >= max(2,(percent*ncol(expnData))) 
    # subset for those genes with cmp >= 1 per gene in samples
    dge <- dge[keep.dge,] #
    dge <- calcNormFactors(dge)
    TMMCPM <- cpm(dge, normalized.lib.sizes = TRUE,
                  log = TRUE, prior.count = add.count)

  }else{
    TMMCPM <- as.matrix(expnData)
    if(!log){
      TMMCPM <- log2(expnData+add.count) #log2 transform counts
    }
  }

  if(is.null(genelist) & filterTopGenes){
      # calculate the variance for each gene
      rv <- rowVars(as.matrix(TMMCPM))
      # select the ntop genes by variance
      select <- order(rv, decreasing=TRUE)[seq_len(min(ntop, length(rv)))]
      #select the top 1000 most varied genes
      TMMCPM <- TMMCPM[select,]
  }else if(!is.null(genelist)){
    TMMCPM <- TMMCPM[which(rownames(TMMCPM) %in% genelist), ] #subset the matrix to genes of interest
  }


  d1 <- dist(t(TMMCPM), method = "euclidean", diag = FALSE,
             upper = FALSE) #sample distances WITHOUT SCALING
  d2 <- dist(TMMCPM, method = "euclidean", diag = FALSE,
             upper = TRUE) #gene distances WITHOUT SCaling
  samp.c1 <- hclust(d1, method = method, members = NULL) #sample clustering
  gene.c2 <- hclust(d2, method = method, members = NULL) #gene clustering
  list <- list(TMMCPM,samp.c1,gene.c2)
  names(list) <- c("TMMCPM","samp.c1", "gene.c2")

  return(list)
}

```

```{r}
create_annots_hmap <- function(expn, pheno_df, cols,
                               goi=NULL,cc=NULL, 
                               colorbar.height=5){
  #expn is the normalized expression values with genes as rownames
  #gene list a character vector
  #goi are genes of interest to highlight on the Heatmap. Character vector of gene symbols
  #cc are color codes in WHICH FORMAT?

  #cols is a character vector of column names

  #Example on how to use the reuslts

  #hmap <- ComplexHmap(XXXX, hmap_anno_obj=res$annoColumn, XXX)
  # draw(hmap + res$geneLabels, heatmap_legend_side="right", annotation_legend_side="right")

    library(dplyr)
    suppressPackageStartupMessages(library(ComplexHeatmap))

    #subset the expression matix and the phenotype dataframe
    anno <- pheno_df %>%
      filter(rownames(.) %in% colnames(expn)) %>% 
      rownames_to_column("id") %>% 
      dplyr::select(id, all_of(cols)) %>%
      mutate(id = factor(id, levels = colnames(expn))) %>%
      arrange(id) %>%  #ensure same order as the expn matrix
      column_to_rownames("id")
  
    #if no color codes provided, create one for each column
    if(is.null(cc)){
      pals <- c("npg", "aaas", "lancet", "jco", 
                    "ucscgb", "uchicago", "simpsons",
                    "rickandmorty")
      #if there are more columns than color palettes, just repeat the set of available color palettes
      if(length(ncol(anno)) > length(pals)){
        pals <- rep(pals,  ceiling(ncol(anno)/length(pals)))
      }
      #define unique colors for each column
      cc <- purrr::map(1:ncol(anno), function(i){
          grps <- unique(anno[[i]])
          ggpubr::get_palette(pals[i], k=length(grps)) %>% 
            magrittr::set_names(grps)
      })
      names(cc) <- colnames(anno)
    }
    
    #legend graphical parameters
    n <- max(sapply(cc, length))
    nrow <- ifelse(n <= 6, n, 6)
    ncol=ceiling(n/nrow)
    params <- list(show_legend=TRUE,
                  labels_gp= gpar(fontsize=12),
                  title_gp= gpar(fontsize=16),
                  nrow = nrow,
                  ncol=3,
                  by_row=TRUE)
    
    #Create the complex heatmap annotation column
    annoCol <- suppressWarnings(HeatmapAnnotation(df = dplyr::select(anno, all_of(cols)),
                                   name="Main Groups",
                                   col=cc,
                                   which="column",
                                   gap=unit(1,"mm"),
                                   border = T,
                                   show_annotation_name = TRUE,
                                   annotation_name_gp=gpar(fontsize=12),
                                   annotation_name_offset=unit(1,"mm"),
                                   annotation_name_side="left",
                                   annotation_height=unit(colorbar.height, "cm"),
                                   annotation_legend_param = params,
                                   simple_anno_size_adjust=TRUE))
    res <- list("annoColumn"=annoCol)
    if(!is.null(goi)){
      regex <- paste0("^",goi,"$", collapse = "|")
      goi.idx <- grep(regex, rownames(expn))
      labels <- rownames(expn)[goi.idx] #needs to be numeric indexes for complexheatmap
      #create the row (gene) labels object
      labs <- rowAnnotation(link = anno_mark(at=goi.idx,
                                             labels=labels,
                                             which="row",
                                             link_width=unit(1, "mm")),
                            width= unit(1, "mm") + max_text_width(labels),
                            gp=gpar(fontsize=4))

      res[["geneLabels"]] <-  labs
    }
    return(res)
}



complex_hmap <- function(mat,
                        hmap_anno_obj,
                        hmap_anno_obj_genes=NULL,
                        name="z-scores",
                        scale=TRUE,
                        space.type="sRGB",
                        color_palette=NULL,
                        split=NULL, 
                        cluster.method="ward.D2",
                        show_sample_ids=FALSE,
                        dge_dendrograms.res=NULL,
                        samp_dend_order=NULL){
  #mat is the normalized, log2 (usually) transformed counts
  #name is the title
  #scale is whether to scale by row
  #color palette is a colorRamp2() object.
  #threshold is whether to make all z-scores in a certain range.
  #hmap_anno_obj is from HeatmapAnnotation() function
  #space.type is for the color/shades on the heatmap. See ?Heatmap for all the choices.
  #dge_dendrograms.res is the list object output from the dge_dendrograms() function.
  #samp_dend_order is the numeric vector or character vector of column names from the matrix (mat) or the dge_dengrograms.res$TMMCPM matix, in the desired order.

  suppressPackageStartupMessages(library(ComplexHeatmap))
  suppressPackageStartupMessages(require(circlize))
  library(RColorBrewer)
  suppressPackageStartupMessages(library(dendextend))
  ht_opt$message = FALSE

  if(is.null(color_palette)){
    pal <- colorRamp2(c(-4,-2, 0, 2, 4),
                      c("deepskyblue3", "deepskyblue","white", "red", "red3"),
                      space=space.type)
  }else{
    pal <- color_palette
  }
  # col <- colorRampPalette(c("cyan1", "cyan2", "cyan3", "cyan4","azure4","magenta4", "magenta3", "magenta2", "magenta1"))(n=299)
  #colorRamp2(c(-2, 0, 4), c("deepskyblue","white", "red"), space="RGB") #use for breaks.
  # colorPal <- colorRampPalette(c("deepskyblue4", "deepskyblue3", "deepskyblue2", "deepskyblue1","white","red1", "red2", "red3", "red4"))(n=299)

  #legend graphical parameters
  params <-  list(color_bar="continuous",
       legend_direction="horizontal",
       title_position="leftcenter",
       legend_width=unit(5,"cm"),
       legend_height=unit(5,"cm"),
       title_gp=gpar(fontsize=10,
                     fontface="bold"))


    if(scale){
      mat <- t(scale(t(mat))) ##rowwise scaling
    }
    print(range(mat))
  
    if(!is.null(dge_dendrograms.res)){
        if(is.null(samp_dend_order)){
          clust <- dendextend::rotate(as.dendrogram(dge_dendrograms.res$samp.c1),
                           order=c(ncol(mat):1))
        }else{
          clust <- dendextend::rotate(as.dendrogram(dge_dendrograms.res$samp.c1),
                                  order=samp_dend_order)
      }
    }else{
      clust=TRUE
    }

    #create the heatmap plot
    hmap <- Heatmap(mat,
                    name=name,
                    col=pal,

                    heatmap_legend_param=params,
                    row_title="Genes",
                    row_title_side="left",
                    row_title_gp=gpar(fontsize=15,
                                      fontface="bold"),
                    show_row_names=FALSE,
                    show_column_names=show_sample_ids,
                    row_names_gp=gpar(fontsize=3),

                    column_title="Samples",
                    column_title_side="bottom",
                    column_title_gp=gpar(fontsize=15,
                                         fontface="bold"),
                    column_title_rot=0,
                    row_dend_width=unit(8,"mm"),
                    column_dend_height=unit(22.5,"mm"),

                    top_annotation=hmap_anno_obj,
                    right_annotation = hmap_anno_obj_genes,
                    split=split,

                    clustering_distance_rows="euclidean",
                    clustering_method_rows=cluster.method,
                    clustering_method_columns = cluster.method,
                    cluster_columns = clust,
                    column_dend_reorder=FALSE)

  return(hmap)
}
```

```{r}
create_pf_heatmaps <- function(TMMCPM,sample_annots, gene_annots,
                               center_scale=TRUE,
                               ntop=1000,order_ids=NULL,
                               genelist=NULL,
                               heatmap_colors=NULL){
  pf_genes <- gene_annots %>% 
    filter(genome=="PF3D7") %>% 
    pull(gene_id)
  
  TMMCPM_all_pf <- TMMCPM[rownames(TMMCPM) %in% pf_genes, ]
  dends <- dge_dendrograms(expnData = TMMCPM_all_pf, 
                           pheno = pull(sample_annots, analysis_group, name = analysis_group_id), 
                           method = "ward.D2",
                           genelist = genelist, 
                           ntop=ntop,
                           log=FALSE,
                           filterTopGenes = TRUE,
                           createDGE = FALSE)
  
  # dim(dends$TMMCPM)
  hmap_anno_obj <- create_annots_hmap(expn=dends$TMMCPM,
                                      pheno_df = sample_annots,
                                      cc=NULL,
                                      colorbar.height=2,
                                      cols = c("analysis_group"))
  name <- ifelse(center_scale, "z-scores","log2_CPM")
  complex_hmap(mat=dends$TMMCPM, 
               scale=center_scale,
               name=name,
               hmap_anno_obj = hmap_anno_obj$annoColumn,
               dge_dendrograms.res = dends,
               samp_dend_order=order_ids,
               color_palette=heatmap_colors,
               show_sample_ids=TRUE)
  
}
```


# Project Files 

Main directory:
/active/kappe_s/kappe/Gigliola/BobM_DuffyNGS_PF_LiverStage

Raw Reads: 
/active/kappe_s/kappe/Gigliola/BobM_DuffyNGS_PF_LiverStage/FASTQ

Genome Refs:
/active/taylor_s/people/jsmi26/RSC/kappe_s_2022.04_rnaseq_quant/species_genomes/concat_genome_refs.sh
/active/taylor_s/people/jsmi26/RSC/kappe_s_2022.04_rnaseq_quant/species_genomes

GRCh38, ensembl v106 annotations
GRCm39, ensembl v106 annotations
Pf3D7, PlasmoDB v58 annotations


STAR aligner:
https://childrens-atlassian/bitbucket/projects/RSC/repos/kappe_s_2022.04_rnaseq_quant/browse?at=refs%2Fheads%2Fkappe_s_2022.06 

```{bash}
data_processing_path="/active/taylor_s/people/jsmi26/CP-Bioinformed/kappe_s_2022.04_rnaseq_quant"
rsync -av $data_processing_path/qc_data .
rsync -av $data_processing_path/raw_counts .
rsync -av $data_processing_path/normalized_counts/ ./expression_data/
rsync -av $data_processing_path/samples .
```

```{bash}
data_processing_path="/active/taylor_s/people/jsmi26/CP-Bioinformed/kappe_s_2022.04_rnaseq_quant"
ln -svf $data_processing_path/species_genomes .
#ln -svf $data_processing_path/ .
```

# Sample Info

```{r}
sra_run_table <- read.csv("samples/SraRunTable.txt") %>% 
  mutate(RNA_label=Run, 
         to_concatenate="No",
         infection_status="SPZ", 
         time_point="Day0",
         analysis_group="sporozorite", 
         analysis_group_id=paste0(analysis_group, "_S", 2:5),
         tissue_source="sporozorite",
         paired_end=FALSE,
         read_length=as.character(AvgSpotLen),
         platform=Instrument,
         parasite_species="Plasmodium falciparum",
         read1_fastq=dir(file.path(ACTIVE,"taylor_s/people/jsmi26/RSC/kappe_s_2022.04_rnaseq_quant/results/sratools"), 
                         pattern = "*.gz"), 
         read2_fastq="") %>% 
  select(sample_id_cat=Run, RNA_label:read2_fastq)

head(sra_run_table)
```

```{r}
#For the concatenated samples 
sample_manifest_cated <- read.csv("samples/Kappe_s_2022.04_PF_LiverStage_concat_sample_manifest.csv") %>% 
  group_by(analysis_group) %>%
  mutate(analysis_group_id=case_when(
    grepl("control|sporozorite", analysis_group) ~ glue::glue("{var}", "_S{1:n()}",
                                                  var=analysis_group),
    grepl("_Pf[\\+-]", analysis_group) ~ glue::glue("{var}", "_S{1:n()}","{var2}",
                                                   var=gsub("(Day[0-9].+)_Pf.$","\\1",analysis_group),
                                                   var2=gsub("Day[0-9].+(_Pf.)$","\\1",analysis_group)))) %>%
  ungroup() %>%
  select(sample_id_cat:analysis_group, analysis_group_id, everything()) %>%
  bind_rows(sra_run_table) %>% 
  as.data.frame() %>%
  set_rownames(.$sample_id_cat)

# sample_manifest_cated
dim(sample_manifest_cated)
table(sample_manifest_cated$analysis_group)
```

# Select Input Samples

```{r}
pf_samples <- sample_manifest_cated %>% 
  filter(grepl("SPZ|Infected", infection_status)) %>% 
  select(sample_id_cat,
         analysis_group_id,
         infection_status, 
         time_point, 
         analysis_group, 
         everything()) %>% 
  set_rownames(.$sample_id_cat)

table(pf_samples$analysis_group)
dim(pf_samples)
```

# Gene Counts 

```{r}
counts_matrix_cated <- read.csv("raw_counts/kappe_s_PfHsMmu_GRCh38_GRCm39_Pf3D7v58_raw_counts.csv") %>% 
  rename_at(vars(gene_name), ~c("gene_id")) %>% 
  select(all_of(c("gene_id", sample_manifest_cated$sample_id_cat))) %>%
  set_rownames(.$gene_id)

head(counts_matrix_cated)
dim(counts_matrix_cated)
dim(sample_manifest_cated)
```

```{r}
mapping_stats <- read.csv("qc_data/kappe_s_PfHsMmu_GRCh38_GRCm39_Pf3D7v58_counts_stats.csv")  %>% 
  rename_at(vars(gene_name), ~c("gene_id")) %>% 
  select(all_of(c("gene_id", sample_manifest_cated$sample_id_cat))) 

head(mapping_stats)
dim(mapping_stats)
```


# Genome References

```{r}
#Gene Refs
species_genes <- read.csv("species_genomes/PfHsMmu_GRCh38_GRCm39_Pf3D7v58_genes_annots.csv") %>% 
  select(gene_name, gene_id, everything()) %>% 
  set_rownames(.$gene_id)

head(species_genes)
```

# Counts and Normalization 

```{r}
dge_all <- edgeR::DGEList(counts=counts_matrix_cated[,-1])
keep <- rowSums(edgeR::cpm(dge_all) > 1) >= 3
dge_all <- dge_all[keep,]

dge_all <- edgeR::calcNormFactors(dge_all, method="TMMwsp")
TMMCPM_all <- as.data.frame(edgeR::cpm(dge_all,normalized.lib.sizes = TRUE, log=FALSE))

dim(TMMCPM_all)  #27711    31
head(TMMCPM_all[,1:5])
```

```{r}
# table(species_genes$genome)
    # Human      Mouse Plasmodium 
    #  50914      35582       5645 
species_genes %>% 
  filter(gene_id %in% rownames(TMMCPM_all)) %>% 
  group_by(genome) %>% 
  dplyr::count() %>% 
  ungroup() %>% 
  bind_cols(as.data.frame(table(species_genes$genome))) %>% 
  rename_at(vars(Freq), ~c("total_genes_in_genome")) %>% 
  mutate(Percent=round(n/total_genes_in_genome*100, digits=2))
```

So there is only 15% coverage of the human genes after filtering to remove low abundance genes -- ughhh 
There is ~23% coverage of the mouse genes, and 85% coverage of the Pf genes :/

```{r}
pf_genes <- species_genes %>% 
  filter(genome=="PF3D7")

pf_counts <- counts_matrix_cated[pf_genes$gene_id,]
dim(pf_counts)
pf_dge <- edgeR::DGEList(counts=pf_counts[,-1],
                         group=sample_manifest_cated$analysis_group,
                         remove.zeros=FALSE)

pf_keep <- rowSums(edgeR::cpm(pf_dge) > 1) >= 3
pf_dge <- pf_dge[pf_keep,]
pf_dge <- edgeR::calcNormFactors(pf_dge, method="TMMwsp")
pf_TMMCPM <- as.data.frame(edgeR::cpm(pf_dge, normalized.lib.sizes = TRUE, log=FALSE))

dim(pf_TMMCPM)  #5188   31
head(pf_TMMCPM[,1:5])

# quantile(as.matrix(pf_TMMCPM))
# quantile(as.matrix(TMMCPM_all))

#these norm factors WAYY inflated tbh
# pf_dge$samples %>% 
#   bind_cols(sample_manifest_cated$analysis_group)

# write.csv(pf_TMMCPM,"expression_data/kappe_s_PF3D7_genes_cated_samples_TMM_CPM.csv")
```

```{r}
pf_expression <- create_long_format_dfs(species_genes=species_genes,
                                        sample_manifest_cated=sample_manifest_cated,
                                        counts_matrix_cated=pf_counts, 
                                        TMMCPM = pf_TMMCPM)

all_genomes_expression <- create_long_format_dfs(species_genes=species_genes,
                                        sample_manifest_cated=sample_manifest_cated,
                                        counts_matrix_cated=counts_matrix_cated, 
                                        TMMCPM = TMMCPM_all)
```



## Compare with Previous Analysis

```{r eval=FALSE}
counts_old <- readRDS("references/previous_analysis/rawcounts.rds")
# head(counts_old)
# dim(counts_old) #5700   11

#https://bioconductor.org/packages/release/bioc/vignettes/TCseq/inst/doc/TCseq.pdf
TCA_old <- readRDS("references/previous_analysis/TCA.rds")

# str(TCA_old)
# TCA_old@design

# pf_counts[grep("PF3D7_0500100|PF3D7_0501800",rownames(pf_counts), ignore.case = TRUE),
#           grep("L1Pf8|Day4.GFP|L1Pf6", colnames(pf_counts))]

sums_old <- colSums(counts_old)

sums_mine <- colSums(pf_counts[,-1])


# sums_old[order(names(sums_old))] %>% 
#   as.data.frame()
# 
# sums_mine[order(names(sums_mine))] %>% 
#   as.data.frame()
```

```{r}
all_cpm_chk <- edgeR::cpm(dge_all)[,"Day2.GFP_L1Pf2xTR2_L1Pf2_S1"]
pf_cpm_ck <- edgeR::cpm(pf_dge)[,"Day2.GFP_L1Pf2xTR2_L1Pf2_S1"]

to_check <- pf_cpm_ck[!pf_cpm_ck==0][1:10]
cbind(to_check, all_cpm_chk[names(to_check)])

# options(scipen = 999)
# quantile(all_cpm)
# quantile(pf_cpm)

#the colsums (library size) is DRASTICALLY different between the full reference, or including only the human reference. 
#thus with so many fewer human reads, it increases the CPM becuase the denominator is much smaller. 
sum(dge_all$counts[,"Day2.GFP_L1Pf2xTR2_L1Pf2_S1"]) #33,468,602
sum(pf_dge$counts[,"Day2.GFP_L1Pf2xTR2_L1Pf2_S1"]) #21,687
```


# QC Overview

## Counted Reads vs Total Sequenced Reads 

```{r}
total_counts <- all_genomes_expression$counts_anno %>% 
  group_by(sample_id_cat) %>% 
  summarise(number_reads=sum(counts)) %>% 
  ungroup() %>% 
  mutate(statistic="total_mapped_count")

mapping_stats_long <- mapping_stats %>% 
  pivot_longer(cols = all_of(sample_manifest_cated$sample_id_cat), 
               names_to="sample_id_cat",
               values_to="number_reads") %>% 
  rename_at(vars(gene_id), ~c("statistic")) %>% 
  mutate_at(vars(sample_id_cat), ~gsub("_unstrand.+","", .)) 

mapping_stats_comparison <- mapping_stats_long %>% 
  bind_rows(., total_counts) %>% 
  group_by(sample_id_cat) %>% 
  mutate(total_reads=sum(number_reads)) %>% 
  mutate(Percent=round(number_reads/total_reads*100, digits=2)) %>% 
  ungroup() %>% 
  arrange(sample_id_cat)

head(mapping_stats_comparison)
# write.csv(mapping_stats_comparison, "expression_data/kappe_s_PfHsMmu_mapping_stats_cated_samples_GRCh38_GRCm39_Pf3D7v58_07.01.2022.csv",
# row.names = FALSE)
```

```{r}
df <- mapping_stats_comparison %>% 
  filter(grepl("total_mapped_count|N_noFeature", statistic)) %>% 
  arrange(Percent) %>% 
  group_by(sample_id_cat) %>% 
  mutate(max=max(Percent)) %>% 
  ungroup() %>% 
  arrange(max) %>% 
  mutate_at(vars(sample_id_cat), ~factor(., levels=unique(.)))

```

```{r fig.height=5, fig.width=12}
nofeature_barplot <- ggplot(df, aes(x=sample_id_cat,  y=Percent, fill=statistic)) +
  geom_bar(stat="identity", position = position_dodge()) +
  theme_classic() +
  labs(title="Mapping Stats for Liver Stage  Pf Infection Samples") +
  theme(axis.text.x = element_text(angle=25, vjust=1, hjust=1, size = 7),
        plot.margin = margin(l=10, unit = "mm")) 

nofeature_barplot
# ggsave(filename="figures/sample_qc/kappe_s_cat_samples_nofeature_exon_gene_counts_barplot.pdf", plot = nofeature_barplot, device = "pdf", height = 5, width = 12)
```

## rRNA 

```{r}
rseq_rRNA_raw <- read.csv("qc_data/kappe_s_PfHsMmu_GRCh38_GRCm39_Pf3D7v58_rRNA_percent_contamination.csv") %>% 
  arrange(percent_rRNA) %>% 
  mutate(sample_id=factor(sample_id, levels=sample_id),
         total_reads=total_records)

head(rseq_rRNA_raw)
```

```{r}
# pdf("figures/sample_qc/rRNA_contamination_per_sample.pdf", height = 7, width = 12)
ggplot(rseq_rRNA_raw, aes(x=sample_id, y=percent_rRNA, fill=total_reads)) +
  geom_col() +
  theme_classic() +
  theme(axis.text.x = element_text(size=10, angle=45, vjust=1, hjust=1),
        plot.margin = margin(l=15, unit="mm")) 

# dev.off()
```


## Read Distribution

```{r}
rseqc_readDist <-  read.csv("qc_data/kappe_s_PfHsMmu_GRCh38_GRCm39_Pf3D7v58_read_distribution.csv")
head(rseqc_readDist)
```

```{r}
CDS_counts <- rseqc_readDist %>% 
  filter(Group=="CDS_Exons") %>% 
  arrange(percent_assigned_tags) %>% 
  mutate(sample=factor(sample, levels = sample))

three_prime_UTR_counts <- rseqc_readDist %>% 
  filter(Group=="3'UTR_Exons") %>% 
  arrange(percent_assigned_tags) %>% 
  mutate(sample=factor(sample, levels = sample))

# head(three_prime_UTR_counts)
```

```{r fig.height=7, fig.width=15}
# pdf("figures/sample_qc/read_distribtion_mapping_per_sample.pdf", height = 7, width = 15)
ggplot(rseqc_readDist %>% 
         filter(!grepl("TSS|ES", Group)) %>% 
         mutate(sample=factor(sample, levels=CDS_counts$sample)),
       aes(x=sample, y=percent_assigned_tags, fill=Group)) +
  geom_col(color=NA) +
  scale_fill_brewer(palette = "Blues")+
  theme_classic() +
  theme(axis.text.x = element_text(size=10, angle=45, vjust=1, hjust=1),
        plot.margin = margin(l=15, unit="mm"))

# dev.off()
```


```{r fig.height=7, fig.width=15}
# pdf()
ggplot(CDS_counts, aes(x=sample, y=percent_assigned_tags, fill=Tags.Kb)) +
  geom_col() +
  # annotate(geom="text", y=75, x=5, label="CDS_Exons") +
  labs(title="CDS_Exons") +
  theme_classic() +
  theme(axis.text.x = element_text(size=10, angle=45, vjust=1, hjust=1),
        plot.margin = margin(l=15, unit="mm"))

ggplot(three_prime_UTR_counts, aes(x=sample, y=percent_assigned_tags, fill=Tags.Kb)) +
  geom_col() +
  labs(title="3'UTR_Exons") +
  theme_classic() +
  theme(axis.text.x = element_text(size=10, angle=45, vjust=1, hjust=1),
        plot.margin = margin(l=15, unit="mm")) 
```

# Expression EDA 

## Gene Expression by Genome

## All Genes 

```{r fig.height=7, fig.width=7}
samples <- unique(all_genomes_expression$CPM_anno$sample_id_cat)

density_plots <- purrr::map(samples,
                               function(samp, CPM_matrix_anno=all_genomes_expression$CPM_anno){
  
  df <- filter(CPM_matrix_anno, sample_id_cat==samp)
  
  if( unique(df$analysis_group) != "control"){
    lab <- paste0("description: ", unique(df$analysis_group))
  }else{
    lab <- paste0("description: ", unique(df$tissue_source))
  }
  ggplot( df, 
          aes(y=genome, x=log2(TMMCPM+1), fill=genome)) +
      ggridges::geom_density_ridges(alpha=0.5, scale=0.75) +
      geom_boxplot(position = position_nudge(y=-0.2),
                   width=0.2,
                   outlier.size=0.5,
                   outlier.alpha=0.5) +
      labs(title=samp) +
      annotate(geom="text", x=10, y=3.5,
               label=lab, size=0.75) +
      theme_classic()
  
})


names(density_plots) <- unique(all_genomes_expression$CPM_anno$analysis_group_id)
length(density_plots)


# density_plots$control_S1
```

## PF3D7 Expression by Timepoint

```{r}
pf_pos_anno <- all_genomes_expression$CPM_anno %>% 
  dplyr::filter(grepl("Pf\\+", analysis_group))

# pdf("figures/uncorrected/Pf3D7_expression_by_timepoint_boxplots.pdf",
#     height = 7, width = 10)

ggplot( pf_pos_anno, 
          aes(y=time_point, x=log2(TMMCPM+1), fill=genome)) +
      # ggridges::geom_density_ridges(alpha=0.5, scale=0.75) +
      geom_boxplot(
        position = position_dodge(),
        # position = position_nudge(y=-0.2),
                   width=0.5,
                   outlier.size=0.5,
                   outlier.alpha=0.5) +
      theme_classic()
# dev.off()
```

```{r}
# pdf("figures/uncorrected/Pf3D7_human_expression_by_timepoint_boxplots.pdf",
#     height = 7, width = 10)


box <- ggplot( pf_pos_anno %>% filter(genome != "GRChm39"), 
          aes(y=time_point, x=log2(TMMCPM+1), fill=genome)) +
      geom_boxplot(
        position = position_dodge(),
        # position = position_nudge(y=-0.2),
                   width=0.5,
                   outlier.size=0.5,
                   outlier.alpha=0.5) +
      theme_classic()

ggplot( pf_pos_anno %>% filter(genome != "GRChm39"), 
          aes(y=log2(TMMCPM+1), 
              x=time_point, 
              fill=genome)) +
  geom_ribbon()
  # ggridges::geom_density_ridges2(alpha=0.5, scale=0.75)




# dev.off()
```

```{r}
df <- pf_pos_anno %>% filter(genome != "GRChm39") %>% 
  select(gene_name,genome, sample_id_cat, time_point, TMMCPM) %>% 
  mutate(log2_TMMCPM=log2(TMMCPM+1)) %>% 
  group_by(time_point, genome) %>% 
  summarize(mean_expn=mean(log2_TMMCPM),
            sd=sd(log2_TMMCPM)) %>% 
  ungroup() %>% 
  mutate(ymin=mean_expn-sd, 
         ymax=mean_expn+sd, 
         alpha=ifelse(genome=="PF3D7", 0.25, 0.1))


df
```

```{r}
ribbon <- ggplot(df, aes(x=time_point, y=mean_expn, group=genome)) +
  geom_ribbon(aes(ymin = ymin, ymax = ymax,
                  group=genome, 
                  fill = genome),
              alpha=c(rep(0.05,4), rep(0.2, 4))) +
  geom_point(aes(color=genome), size=3) +
  geom_line(aes(color=genome)) +
  scale_x_discrete(expand = c(0.01,0.01)) +
  scale_color_viridis_d(option = "D", begin=0, end=0.8) +
  scale_fill_viridis_d(option = "D", begin=0, end=0.8) +
  labs(y="Mean Gene Expression\nlog2(CPM+1)", x="Time point") +
  theme_classic() +
  theme(axis.text = element_text(color="black", size=12))

svg(filename = "figures/uncorrected/Pf3D7_human_expression_by_timepoint_ribbon_plot.svg",
    height = 5, width = 7)
ribbon
dev.off()

```



## Expression Per Sample

```{r}
groups <- unique(sample_manifest_cated$analysis_group) 
grouped_plots <- purrr::map(groups, function(grp){
  
  plots <- sample_manifest_cated %>% 
    filter(analysis_group==grp) %>% 
    pull(analysis_group_id)
  
  n <- length(plots)
  nrow <- ifelse(n<=2 | n==4, 2, 3)
  ncol=ceiling(n/nrow)
  p <- marrangeGrob(grobs=density_plots[plots], nrow=nrow, ncol=ncol)
  
  fname <- file.path("figures/sample_qc",paste0("kappe_s_cated_samples_all_genomes_",grp,".pdf"))
  print(fname)
  width <- ifelse(ncol>=2, 16, 8)
  ggsave(filename = fname,
         plot = p,
         device = "pdf",
         height = 12, width = width)
})
# names(grouped_plots) <- unique(sample_manifest_cated$analysis_group) 
```


## Plasmodium Genes 

```{r fig.height=7, fig.width=7}

pf_samples_ids <- unique(pf_expression$CPM_anno$sample_id_cat)

pf_density_plots <- purrr::map(pf_samples_ids,
                               function(samp, CPM_matrix_anno=pf_expression$CPM_anno){
  
  df <- filter(CPM_matrix_anno, sample_id_cat==samp)
  
  if( unique(df$analysis_group) != "control"){
    lab <- paste0("description: ", unique(df$analysis_group))
  }else{
    lab <- paste0("description: ", unique(df$tissue_source))
  }
  ggplot( df, 
          aes(y=genome, x=log2(TMMCPM+1), fill=genome)) +
      ggridges::geom_density_ridges(alpha=0.5, scale=0.75) +
      geom_boxplot(position = position_nudge(y=-0.2),
                   width=0.2,
                   outlier.size=0.5,
                   outlier.alpha=0.5) +
      labs(title=samp) +
      annotate(geom="text", x=10, y=3.5,
               label=lab, size=0.75) +
      theme_classic()
  
})


names(pf_density_plots) <- unique(pf_expression$CPM_anno$analysis_group_id)
length(pf_density_plots)
# pf_density_plots$control1
```

```{r}
groups <- unique(sample_manifest_cated$analysis_group) 
grouped_plots <- purrr::map(groups, function(grp, density_plots=pf_density_plots){
  
  plots <- sample_manifest_cated %>% 
    filter(analysis_group==grp) %>% 
    pull(analysis_group_id)
  
  n <- length(plots)
  nrow <- ifelse(n<=2 | n==4, 2, 3)
  ncol=ceiling(n/nrow)
  p <- marrangeGrob(grobs=density_plots[plots], nrow=nrow, ncol=ncol)
  
  fname <- file.path("figures",paste0("kappe_s_cated_samples_pf_genes_only",grp,".pdf"))
  # print(fname)
  width <- ifelse(ncol>=2, 16, 8)
  ggsave(filename = fname,
         plot = p,
         device = "pdf",
         height = 12, width = width)
})
# names(grouped_plots) <- unique(sample_manifest_cated$analysis_group) 
```

## Boxplots of Expression 

```{r}
pos <- sample_manifest_cated %>% 
  filter(grepl("cont|spo|Pf\\+", analysis_group))

neg <- sample_manifest_cated %>% 
  filter(grepl("cont|spo|Pf\\-", analysis_group))
```

```{r fig.height=6, fig.width=10}
pos_gex <- pf_expression$CPM_anno %>% 
  filter(sample_id_cat %in% pos$sample_id_cat) %>% 
  mutate(log2_TMMCPM=log2(TMMCPM+1)) %>% 
  arrange(analysis_group) 

neg_gex <- pf_expression$CPM_anno %>% 
  filter(sample_id_cat %in% neg$sample_id_cat) %>% 
  mutate(log2_TMMCPM=log2(TMMCPM+1)) %>% 
  arrange(analysis_group) 


ggplot(pos_gex, aes(x=analysis_group_id, y=log2_TMMCPM)) +
  geom_boxplot(aes(fill=analysis_group)) +
  theme(axis.text.x = element_text(angle=25, vjust=1, hjust=1))

ggplot(neg_gex, aes(x=analysis_group_id, y=log2_TMMCPM)) +
  geom_boxplot(aes(fill=analysis_group)) +
  theme(axis.text.x = element_text(angle=25, vjust=1, hjust=1))
```


```{r fig.height=6, fig.width=10}
pos_gex_all <- all_genomes_expression$CPM_anno %>% 
  filter(sample_id_cat %in% pos$sample_id_cat) %>% 
  mutate(log2_TMMCPM=log2(TMMCPM+1)) %>% 
  arrange(analysis_group)  %>% 
  filter(genome=="PF3D7")

neg_gex_all <- all_genomes_expression$CPM_anno %>% 
  filter(sample_id_cat %in% neg$sample_id_cat) %>% 
  mutate(log2_TMMCPM=log2(TMMCPM+1)) %>% 
  arrange(analysis_group) %>% 
  filter(genome=="PF3D7")


ggplot(pos_gex_all, aes(x=analysis_group_id, y=log2_TMMCPM)) +
  geom_boxplot(aes(fill=analysis_group)) +
  theme(axis.text.x = element_text(angle=25, vjust=1, hjust=1))

ggplot(neg_gex_all, aes(x=analysis_group_id, y=log2_TMMCPM)) +
  geom_boxplot(aes(fill=analysis_group)) +
  theme(axis.text.x = element_text(angle=25, vjust=1, hjust=1))
```

## PCA 

### Pf Genes 

```{r}
pf_pheno <- pull(sample_manifest_cated, analysis_group, name=sample_id_cat)
pf_PCA <- PCA(expnData = pf_expression$counts, phenovector = pf_pheno, ntop = 500)
```

```{r}
cc_analysis_group <- get_palette("jco", k=length(unique(sample_manifest_cated$analysis_group))) %>% 
  set_names(unique(sample_manifest_cated$analysis_group))
```

```{r}
pf_pheno_gfp <- pull(sample_manifest_cated, infection_status, name=sample_id_cat)
pf_gfp_PCA <- PCA(expnData = pf_expression$counts, phenovector = pf_pheno_gfp, ntop = 500)
```

```{r fig.height=8}
# pdf("figures/exploratory/kappe_s_Pf_LS_cated_samples_labels_500_mostVarGenes_PF3D7genome.pdf", height = 6, width = 10)
pf_PCA$pca_plots[[1]] +
  scale_color_manual(values=cc_analysis_group) +
  xlim(-150,200) +
    ggrepel::geom_text_repel(data=pf_PCA$pca_data$scores,
                       mapping=aes(x=PC1, y=PC2, label=name),
                       max.overlaps=20, size=3,
                       point.padding = 0.01,
                       min.segment.length=0.01) 
# dev.off()
```

```{r fig.height=8, fig.width=16}
# pdf("figures/exploratory/kappe_s_Pf_LS_cated_samples_byDay_500_mostVarGenes_PF3D7genome.pdf", height = 8, width = 16)
pf_PCA$pca_plots[[1]] + pf_PCA$pca_plots[[2]] 
# dev.off()

# pdf("figures/exploratory/kappe_s_Pf_LS_cated_samples_byInfection_500_mostVarGenes_PF3D7genome.pdf", height = 8, width = 16)
pf_gfp_PCA$pca_plots[[1]] + pf_gfp_PCA$pca_plots[[2]]
# dev.off()
```

## All Genomes 

```{r}
pheno <- pull(sample_manifest_cated, analysis_group, name=sample_id_cat)

pca_grps <- PCA(expnData = all_genomes_expression$counts, phenovector = pheno)
```

```{r fig.height=6, fig.width=16}
pca_grps$pca_plots[[1]] + pca_grps$pca_plots[[2]]
```

```{r}
pca_grps$pca_data$rotation %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  left_join(., species_genes, by="gene_id") %>% 
  group_by(genome) %>% 
  dplyr::count()
```

# Parasites Clustering 

```{r}
#Examine the total pf gene read counts per Pf+ sample
total_counts_pf_reads <- pf_expression$counts_anno %>% 
  filter(sample_id_cat %in% pf_samples$sample_id_cat) %>% 
  filter(genome=="PF3D7") %>% 
  group_by(analysis_group,
           analysis_group_id,
           RNA_label,sample_id_cat,
           time_point) %>% 
  summarise(total_counts=sum(counts),
            sd=sd(counts),
            .groups="keep") %>% 
  arrange(desc(total_counts), .by_group=TRUE) %>% 
  ungroup() %>% 
  mutate(biological_replicate=case_when(
    grepl("^SRR", RNA_label) ~ gsub("spor.+_S([0-9])","Rep\\1", analysis_group_id),
    grepl("L1", RNA_label) ~ "Rep1",
    grepl("L2", RNA_label) ~ "Rep2",
    grepl("L3", RNA_label) ~ "Rep3")) %>%
  arrange(time_point, biological_replicate) %>% 
  mutate(analysis_group_id=factor(analysis_group_id, levels = analysis_group_id ))


total_counts_pf_reads
# table(pf_samples$analysis_group)
# table(pf_samples_clean$analysis_group)
```

```{r}
# pdf("figures/sample_qc/kappe_s_pf_cated_samples_gene_counts_per_replicate.pdf", height = 6, width = 9)
ggplot(total_counts_pf_reads, aes(x=time_point,
                                  y=total_counts,
                                  # color=analysis_group_id,
                                  fill=biological_replicate)) +
  geom_col(position = position_dodge()) +
  labs(y="pf gene counts") +
  guides(color='none') +
  facet_wrap(~time_point, scales = 'free') +
  theme_classic()
# dev.off()
```


## Most Varied Genes 

## All Samples 

```{r}
suppressPackageStartupMessages(library(circlize))
```

```{r}
pf_samples <- pf_samples %>% 
  set_rownames(.$analysis_group_id)

TMMCPM_pf_pos <- pf_expression$TMMCPM[,pf_samples$sample_id_cat] %>% 
                     set_colnames(pf_samples$analysis_group_id)
# keep <- TMMCPM_pf_pos[,"sporozorite_S1"] > 1
# table(keep)
# TMMCPM_pf_pos <- TMMCPM_pf_pos[keep,]

dim(TMMCPM_pf_pos)
class(TMMCPM_pf_pos)
```


```{r fig.height=7, fig.width=14}
# col <- colorRampPalette(c("cyan1", "cyan2", "cyan3", "cyan4","azure4","magenta4", "magenta3", "magenta2", "magenta1"))(n=299)
color_map <- colorRamp2(c(-3.5,-1.5, 0,1.5, 3.5), c("dodgerblue4", "dodgerblue1","white","red1", "red4"), space="sRGB") #use for breaks.

# pdf("figures/parasites_clustering/kappe_s_pf_pos_top500MostVarGenes_allSamps_07.01.2022.pdf", height = 8, width = 14)
create_pf_heatmaps(TMMCPM=TMMCPM_pf_pos,
                   sample_annots=pf_samples, 
                   gene_annots=species_genes,
                   order_ids = pf_samples$analysis_group_id,
                   heatmap_colors = color_map,
                   ntop=500)
# dev.off()
```

```{r fig.height=7, fig.width=14}
# pdf("figures/parasites_clustering/kappe_s_pf_pos_top500MostVarGenes_D456_07.01.2022.pdf", height = 8, width = 14)
pf_samples_D456 <- pf_samples %>% 
  filter(!grepl("Day2", time_point)) %>% 
  set_rownames(.$analysis_group_id)

create_pf_heatmaps(TMMCPM=TMMCPM_pf_pos,
                   sample_annots=pf_samples_D456, 
                   gene_annots=species_genes,
                   order_ids = pf_samples_D456$analysis_group_id,
                   heatmap_colors = color_map,
                   ntop=500)
# dev.off()
```

```{r fig.height=7, fig.width=14}
# col <- colorRampPalette(c("cyan1", "cyan2", "cyan3", "cyan4","azure4","magenta4", "magenta3", "magenta2", "magenta1"))(n=299)
col <- colorRamp2(c(-3,-1.5, 0,1.5, 3), c("dodgerblue4", "dodgerblue1","white","red1", "red4"), space="sRGB") #use for breaks.

# pdf("figures/parasites_clustering/kappe_s_pf_pos_top500MostVarGenes_allGenomesNorm_06.01.2022.pdf", height = 8, width = 14)
create_pf_heatmaps(TMMCPM=as.matrix(TMMCPM_all[,pf_samples$sample_id_cat]) %>% 
                     set_colnames(pf_samples$analysis_group_id),
                   sample_annots=pf_samples, 
                   gene_annots=species_genes,
                   order_ids = pf_samples$analysis_group_id,
                   heatmap_colors = col,
                   ntop=500)
# dev.off()
```


## Largest Fold-change Genes


```{r}
# pf_expression$CPM_anno %>% 
#   select(gene_id, gene_name,analysis_group,analysis_group_id, TMMCPM)
```

```{r}
TMMCPM_pf_FC <- TMMCPM_pf_pos %>% 
  rownames_to_column("gene_id") %>% 
  pivot_longer(cols = matches("Day|sporo"), 
               names_to="analysis_group_id",
               values_to="TMMCPM") %>% 
  mutate(group=ifelse(grepl("sporo",analysis_group_id), "spz", "heps"))
  pivot_wider(names_from=group, values_from=TMMCPM)
  left_join(select(species_genes,gene_id, genome),
            by="gene_id") %>%

  group_by(gene_id) %>%
  mutate_at(vars(spz), ~case_when(
    is.na(.) ~ unique(.[!is.na(.)])
  )) %>%
  ungroup()
  filter(!grepl("sporozorite_S1", analysis_group_id)) %>%
  mutate(time_point=str_split_fixed(analysis_group_id, pattern = "_",n=2)[,1]) %>%
  group_by(gene_id, time_point) %>%
  summarise(mean_heps=mean(heps),
            mean_spz=mean(spz),
            .groups="keep") %>%
  ungroup() %>%
  mutate(ratio=(mean_heps+1)/(mean_spz+1)) %>%
  mutate(fold_change=ifelse(ratio < 1, -1/ratio, ratio)) %>%
  arrange(time_point, desc(fold_change))


head(TMMCPM_pf_FC)
# quantile(TMMCPM_pf_FC$fold_change)
```

```{r}
DE_genes <- TMMCPM_pf_FC %>%
  filter(mean_spz >= 10, abs(fold_change) > 2) %>% 
  # filter(mean_heps > 1) %>% 
  mutate(direction=case_when(
    fold_change > 0 ~ "up",
    fold_change < 0 ~ "down")) 

sel_genes <- 
  group_by(time_point,direction) %>%
  mutate(largest_effect_size=abs(fold_change) >= quantile(abs(fold_change), probs=0.90)) %>%
  ungroup() %>% 
  filter(largest_effect_size)


dim(sel_genes)
table(sel_genes$time_point,
      sel_genes$direction) 

```

```{r fig.height=7, fig.width=14}
SCALE=FALSE
if(SCALE){
col <- colorRamp2(c(-3,-1.5, 0,1.5, 3), 
                  c("dodgerblue4", "dodgerblue1","white","red1", "red4"), space="sRGB") #use for breaks.
type <- "zscores"
}else{
col <- colorRamp2(seq(0,20,length.out = 5),
                  c("white",paste0("firebrick",1:4)),
                  space="sRGB") #use for breaks
type="log2CPM"
}

day456_sel <-  sel_genes %>% 
  filter(time_point != "Day2")

# pdf(paste0("figures/parasites_clustering/kappe_s_pf_cated_samples_Pos_largestFC_",type,"_07.01.2022.pdf"), height = 8, width = 14)
no_day2 <- filter(pf_samples,!grepl("Day2", analysis_group)) 
create_pf_heatmaps(TMMCPM=pf_expression$TMMCPM[,pf_samples$sample_id_cat] %>% 
                     set_colnames(pf_samples$analysis_group_id),
                   sample_annots=no_day2, 
                   gene_annots=species_genes,
                   center_scale=SCALE,
                   order_ids = rev(no_day2$analysis_group_id),
                   genelist=unique(day456_sel$gene_id),
                   heatmap_colors = col)
# dev.off()
```

```{r fig.height=7, fig.width=14}
purrr::map(paste0("Day",c(2,4:6)), function(day){
  
  samps <- pf_samples %>% 
    filter(time_point=="Day0" | time_point==day)
  genes <- sel_genes %>% 
    filter(time_point==day) 
  
  col <- colorRamp2(c(-1.5,-1, 0, 1, 1.5), 
                    c("dodgerblue4", "dodgerblue1","white","red1", "red4"), 
                    space="sRGB") #use for breaks.
  
  # pdf(paste0("figures/parasites_clustering/kappe_s_pf_cated_samples_pos_largestFC_",day,"_07.01.2022.pdf"),
  #     height = 8, width = 14)
  print(create_pf_heatmaps(TMMCPM=pf_expression$TMMCPM[,pf_samples$sample_id_cat] %>% 
                     set_colnames(pf_samples$analysis_group_id),
                   sample_annots=samps,
                   gene_annots=species_genes,
                   order_ids = rev(samps$analysis_group_id),
                   genelist=unique(genes$gene_id),
                   heatmap_colors = col))
  # dev.off()
})
```


# Share the Data 

I think I need to consider best practices here... not sure yet. 

```{bash}
rsync -av figures /active/kappe_s/kappe/Gigliola/2022.04_jsmi26_PF_LiverStage/
rsync -av expression_data /active/kappe_s/kappe/Gigliola/2022.04_jsmi26_PF_LiverStage/
rsync -av presentations /active/kappe_s/kappe/Gigliola/2022.04_jsmi26_PF_LiverStage/
```



# Session Information

```{r}
sessionInfo()
```



